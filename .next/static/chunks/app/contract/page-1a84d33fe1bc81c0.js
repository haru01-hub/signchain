(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[793,534],{2480:function(){},2678:function(){},5819:function(){},4112:function(){},3454:function(e,t,n){Promise.resolve().then(n.bind(n,3527))},3527:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return F}});var o=n(7437),i=n(2265),r=n(7648),a=n(9376),s=n(9743),l=n(4335),d=n(9655),c=n(3566),u=n.n(c),f=n(8598),g=n.n(f),p=n(5801),h=n(9517),x=function(e){let{userEmail:t,type:n,onMessageAction:r,visible:c=!0}=e,{notifications:f,loading:x,refreshNotifications:y}=(0,h.n)(),[m,v]=(0,i.useState)([]),[b,w]=(0,i.useState)(null),[j,S]=(0,i.useState)(null),[C,k]=(0,i.useState)("all"),[E,I]=(0,i.useState)("idle"),[D,R]=(0,i.useState)(""),[B,z]=(0,i.useState)(""),[T,W]=(0,i.useState)(null),P=(0,i.useRef)(null),[U,G]=(0,i.useState)(null),[K,O]=(0,i.useState)(!1),[A,N]=(0,i.useState)(!1),F=(0,a.useRouter)(),[M,L]=(0,i.useState)(!1),[H,Q]=(0,i.useState)(""),[Z,q]=(0,i.useState)(null),[J,_]=(0,i.useState)(!1),[V,X]=(0,i.useState)(!1);i.useEffect(()=>{v(f)},[f]);let Y=async()=>{R("전자서명 중...");try{if(!U||!t)throw Error("필수 정보 없음");let e=await fetch("/api/contract/".concat(U)),n=await e.json();if(!e.ok)throw Error(n.message||"계약서 조회 실패");if(n.expiryDate&&new Date(n.expiryDate)<new Date){R("계약 유효기간이 만료되었습니다."),setTimeout(()=>R(""),1500),I("idle");return}let o=await fetch("/api/digital-sign/digital-signature",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:t,hash:n.fileHash,contractId:U})}),i=await o.json();if(!o.ok)throw Error(i.message||"전자서명 실패");R("전자서명 완료!"),I("hand")}catch(e){R("전자서명 실패: "+(e instanceof Error?e.message:String(e))),I("idle")}},$=async()=>{z("손글씨 서명 처리 중...");try{var e,t;if(!U)throw Error("contractId 없음");let n=null===(t=P.current)||void 0===t?void 0:null===(e=t.getTrimmedCanvas())||void 0===e?void 0:e.toDataURL("image/png");if(!n)throw Error("서명 데이터 없음");let o=u()(n).toString(g()),i=await fetch("/api/contract/".concat(U),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({signatureImage:n,signatureImageHash:o})}),r=await i.json();if(!i.ok)throw Error(r.message||"손글씨 서명 실패");if(r.expiryDate&&new Date(r.expiryDate)<new Date){z("계약 유효기간이 만료되었습니다."),setTimeout(()=>z(""),1500),I("idle");return}z("서명이 성공적으로 완료되었습니다"),I("done")}catch(e){z("손글씨 서명 실패: "+(e instanceof Error?e.message:String(e))),I("idle")}},ee=async()=>{L(!1),Z&&(await fetch("/api/contract/".concat(Z)),await fetch("/api/contract/receive",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contractId:Z,received:!0})}),r&&(r(Z),setTimeout(()=>r(Z),500))),q(null),Q("")},et=async()=>{L(!1),Z&&(await fetch("/api/contract/receive",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({contractId:Z,rejected:!0})}),r&&(r(Z),setTimeout(()=>r(Z),500))),q(null),Q("")};return(0,o.jsxs)("div",{style:{display:c?void 0:"none"},children:[(0,o.jsx)(s.Z,{notifications:m.filter(e=>!n||e.type===n).filter(e=>"all"===C||("unread"===C?!e.read:e.read)),loading:x,selectedId:b,onNotificationClick:e=>{var t,n,o;if((null===(t=e.message)||void 0===t?void 0:t.includes("만료"))||(null===(n=e.message)||void 0===n?void 0:n.includes("거부"))){_(!0);return}w(e._id),S(e);let i=e.contractId||(null===(o=e.message.match(/contractId:([\w\d]+)/))||void 0===o?void 0:o[1])||e._id||null;if(G(i),"message"===e.type){let t=e.message.split(" 계약서가 도착")[0]||"",n=e.senderEmail?(0,s.I)(e.senderEmail):"";Q("".concat(n," 님에게 ").concat(t," 계약서가 도착했습니다. 계약서를 수신하시겠습니까?")),q(i),L(!0)}},filter:C,setFilter:k,onRead:e=>{v(t=>t.map(t=>t.id===e?{...t,read:!0}:t))},onDelete:e=>{v(t=>t.filter(t=>t.id!==e))}}),K&&(0,o.jsx)(p.Z,{onQrSuccess:()=>{O(!1),N(!0),I("sign")},qrVerified:A,contractId:U||"",qrCode:(null==j?void 0:j.contractId)||""}),"idle"!==E&&(0,o.jsx)(d.Z,{step:E,signStatus:D,handStatus:B,onSign:Y,onHandSign:$,sigCanvasRef:P,clearSig:()=>{var e;return null===(e=P.current)||void 0===e?void 0:e.clear()},isValid:T,onClose:()=>{I("idle"),R(""),z(""),W(null)}}),M&&(0,o.jsx)(l.Z,{message:H,onConfirm:ee,onCancel:et,integrityMsg:""}),J&&(0,o.jsx)(l.Z,{message:"계약서가 만료/거부되었습니다. 만료일 연장/재계약 하시겠습니까?",onConfirm:()=>{_(!1),X(!0)},onCancel:()=>{_(!1),F.push("/contract")}})]})},y=n(4260),m=n(6823),v=n(6829),b=n.n(v),w=n(9274);function j(e){let{onMessageAction:t}=e,[n,s]=(0,i.useState)(null),[d,c]=(0,i.useState)(0),[u,f]=(0,i.useState)(0),[g,p]=(0,i.useState)(!1),[h,v]=(0,i.useState)(""),[j,S]=(0,i.useState)(""),[C,k]=(0,i.useState)(null),[E,I]=(0,i.useState)(null),D=function(){let[e,t]=(0,i.useState)(null);return(0,i.useEffect)(()=>{function e(){fetch("/api/user/me").then(e=>e.json()).then(e=>t(e)).catch(()=>t(null))}e();let n=()=>e();return window.addEventListener("user-profile-updated",n),()=>{window.removeEventListener("user-profile-updated",n)}},[]),e}(),R=(0,a.useRouter)(),B=(0,i.useRef)(null),z=(0,i.useRef)(null),[T,W]=(0,i.useState)(!1);(0,i.useEffect)(()=>{let e=!1;async function t(){try{let t=await fetch("/api/auth/notifications"),n=await t.json(),o=(n.notifications||[]).filter(e=>"system"===e.type&&!e.read).length,i=(n.notifications||[]).filter(e=>"message"===e.type&&!e.read).length;e||(c(o),f(i))}catch(t){e||(c(0),f(0))}}t();let n=setInterval(t,3e4);return()=>{e=!0,clearInterval(n)}},[]),(0,i.useEffect)(()=>{function e(e){!g&&(document.querySelector(".confirm-modal-backdrop")||("system"===n&&B.current&&!B.current.contains(e.target)&&s(null),"message"===n&&z.current&&!z.current.contains(e.target)&&s(null)))}return n&&document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[n,g]);let P=async()=>{if(p(!1),"message"===E&&C)try{await fetch("/api/contract/".concat(C)),await fetch("/api/contract/receive",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({contractId:C})}),t&&t(C)}catch(e){}k(null),v(""),S(""),I(null)};return(0,o.jsxs)("nav",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",padding:16,background:"#f0f4ff",borderBottom:"1px solid #e0e7ef",position:"relative",zIndex:100},children:[(0,o.jsx)("div",{style:{fontWeight:700,fontSize:20},children:(0,o.jsx)(r.default,{href:"/",children:"SignChain"})}),(0,o.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:18},children:[(0,o.jsxs)("div",{ref:B,className:b().clickable,style:{position:"relative",marginRight:4},onClick:()=>s("system"===n?null:"system"),children:[(0,o.jsxs)("span",{className:b().clickable,"aria-label":"시스템 알림",tabIndex:0,onKeyDown:e=>{("Enter"===e.key||" "===e.key)&&s("system"===n?null:"system")},title:"시스템 알림",children:[(0,o.jsx)(y.Z3q,{style:{color:"#222",fontSize:22}}),d>0&&(0,o.jsx)("span",{style:{position:"absolute",top:-8,right:-8,background:"#0074ff",color:"#fff",borderRadius:"50%",minWidth:22,height:22,display:"flex",alignItems:"center",justifyContent:"center",fontSize:15,fontWeight:500,boxShadow:"0 1px 4px #0002",border:"2px solid #fff",zIndex:2},children:d})]}),"system"===n&&(0,o.jsx)("div",{style:{position:"absolute",right:0,top:40},children:(0,o.jsx)(x,{type:"system",userEmail:null==D?void 0:D.email,visible:"system"===n})})]}),(0,o.jsxs)("div",{ref:z,className:b().clickable,style:{position:"relative",marginRight:8},onClick:()=>s("message"===n?null:"message"),children:[(0,o.jsxs)("span",{className:b().clickable,"aria-label":"수신 알림",tabIndex:0,onKeyDown:e=>{("Enter"===e.key||" "===e.key)&&s("message"===n?null:"message")},title:"수신 알림",children:[(0,o.jsx)(y.uWG,{style:{color:"#222",fontSize:22}}),u>0&&(0,o.jsx)("span",{style:{position:"absolute",top:-8,right:-8,background:"#0074ff",color:"#fff",borderRadius:"50%",minWidth:22,height:22,display:"flex",alignItems:"center",justifyContent:"center",fontSize:15,fontWeight:500,boxShadow:"0 1px 4px #0002",border:"2px solid #fff",zIndex:2},children:u})]}),"message"===n&&(0,o.jsx)("div",{style:{position:"absolute",right:0,top:40},children:(0,o.jsx)(x,{type:"message",userEmail:null==D?void 0:D.email,visible:"message"===n})})]}),(0,o.jsx)(r.default,{href:"/introduction",className:b().clickable,style:{fontWeight:500},children:"프로젝트 소개"}),D&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsxs)("div",{className:b().clickable,style:{display:"flex",alignItems:"center",gap:8,marginRight:8},onClick:()=>R.push("/profile"),tabIndex:0,"aria-label":"프로필 관리로 이동",onKeyDown:e=>{("Enter"===e.key||" "===e.key)&&R.push("/profile")},children:[(0,o.jsx)(y.m3W,{size:32,color:"#b0b8c1",style:{border:"2px solid #003cff",borderRadius:"50%",background:"#e0e4ea"}}),(0,o.jsx)("span",{style:{fontWeight:600,color:"#003cff"},children:D.username})]}),(0,o.jsx)("button",{className:b().clickable,onClick:async()=>{await fetch("/api/auth/logout",{method:"POST"}),window.location.href="/"},style:{fontWeight:500,color:"#ff3b3b",background:"none",border:"none",fontSize:"1rem"},children:"로그아웃"}),(0,o.jsx)("button",{className:b().clickable,onClick:async()=>{if(window.confirm("정말로 회원탈퇴 하시겠습니까? 모든 데이터가 삭제됩니다."))try{if((await fetch("/api/user/delete",{method:"DELETE"})).ok){let e=localStorage.getItem("userId"),t=e?await (0,w.vm)(e):"";t&&await (0,m.deletePrivateKey)(t);let n=0,o=0,i=()=>{localStorage.clear(),sessionStorage.clear(),window.location.href="/"};if(window.indexedDB){n=2;let e=window.indexedDB.deleteDatabase("signchain-key");e.onsuccess=e.onerror=e.onblocked=()=>{++o===n&&i()};let t=window.indexedDB.deleteDatabase("signchain-token");t.onsuccess=t.onerror=t.onblocked=()=>{++o===n&&i()}}else i()}else W(!0)}catch(e){W(!0)}},style:{fontWeight:500,color:"#888",background:"none",border:"none",fontSize:"1rem",marginLeft:8},children:"회원탈퇴"})]})]}),g&&(0,o.jsx)(l.Z,{message:(h?h+"\n":"")+(j||""),onConfirm:P,onCancel:()=>p(!1),integrityMsg:""}),T&&(0,o.jsx)(l.Z,{message:"회원탈퇴에 실패했습니다. 다시 시도해주세요.",onConfirm:()=>W(!1),onCancel:()=>W(!1),integrityMsg:""})]})}var S=n(6181);function C(e){let{signContractId:t,signContractHash:n,onSigned:i,signStatus:r}=e;return(0,o.jsx)("div",{style:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",background:"#0008",zIndex:2200,display:"flex",alignItems:"center",justifyContent:"center"},children:(0,o.jsxs)("div",{style:{background:"#fff",borderRadius:10,padding:32,minWidth:340,boxShadow:"0 2px 16px #0003",textAlign:"center"},children:[(0,o.jsx)("h2",{children:"계약서 서명"}),(0,o.jsx)(S.Z,{contractId:t,contractHash:n,onSigned:i}),r&&(0,o.jsx)("div",{style:{color:"green",marginTop:16},children:r})]})})}function k(e){let{file:t,recipientEmail:n,emailStatus:i,uploadStatus:r,uploadMsg:a,handleUpload:s,handleFileChange:l,handleRecipientEmailChange:d,emailMsg:c,user:u}=e;return(0,o.jsxs)("form",{onSubmit:s,style:{marginBottom:32,background:"#f4f8ff",padding:20,borderRadius:10,boxShadow:"0 2px 8px #0001",position:"relative",overflow:"hidden"},tabIndex:0,onKeyDown:e=>{"Enter"===e.key&&t&&n&&"valid"===i&&"uploading"!==r&&s(e)},children:[(0,o.jsxs)("div",{style:{display:"flex",gap:16,alignItems:"center",flexWrap:"wrap"},children:[(0,o.jsx)("input",{type:"file",name:"file",accept:".pdf,.docx,.txt",onChange:l,style:{flex:1,cursor:"pointer",boxShadow:void 0,transition:"box-shadow 0.18s"},required:!0,onMouseOver:e=>e.currentTarget.style.boxShadow="0 4px 16px rgba(25, 118, 210, 0.18)",onMouseOut:e=>e.currentTarget.style.boxShadow=""}),(0,o.jsx)("div",{style:{fontSize:13,color:"#888",marginTop:4},children:"PDF, DOCX, TXT 파일만 업로드할 수 있습니다."}),(0,o.jsxs)("div",{style:{display:"flex",alignItems:"center",flex:1,gap:8},children:[(0,o.jsx)("input",{type:"email",placeholder:"수신자 이메일",value:n,onChange:d,style:{flex:1,borderColor:"invalid"===i||u&&n===u.email?"red":void 0},required:!0}),n&&(0,o.jsxs)("span",{style:{display:"flex",alignItems:"center",gap:4},children:["valid"===i&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(y.FJM,{color:"green",style:{fontSize:16}}),(0,o.jsx)("span",{style:{color:"green",fontSize:13,marginLeft:2},children:"등록된 이메일입니다."})]}),"invalid"===i&&"본인 이메일로는 보낼 수 없습니다."===c&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(y.G5m,{color:"red",style:{fontSize:16}}),(0,o.jsx)("span",{style:{color:"red",fontSize:13,marginLeft:2},children:"본인 이메일로는 보낼 수 없습니다."})]}),"invalid"===i&&"본인 이메일로는 보낼 수 없습니다."!==c&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(y.G5m,{color:"red",style:{fontSize:16}}),(0,o.jsx)("span",{style:{color:"red",fontSize:13,marginLeft:2},children:c})]}),"checking"===i&&(0,o.jsx)(y.fCD,{className:"spin",color:"#888",style:{fontSize:16}})]})]}),(0,o.jsx)("button",{type:"submit",className:"clickable",disabled:"uploading"===r||"valid"!==i,style:{background:"#1976d2",color:"#fff",border:"none",borderRadius:6,padding:"8px 18px",fontWeight:500,display:"flex",alignItems:"center",gap:8,transition:"background 0.18s, box-shadow 0.18s",boxShadow:void 0,cursor:"pointer"},onMouseOver:e=>e.currentTarget.style.boxShadow="0 4px 16px rgba(25, 118, 210, 0.18)",onMouseOut:e=>e.currentTarget.style.boxShadow="",children:"uploading"===r?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(y.fCD,{className:"spin",style:{fontSize:16}})," 업로드 중..."]}):"계약서 업로드"})]}),a&&(0,o.jsxs)("div",{style:{color:"success"===r?"green":"red",marginTop:8,fontWeight:600,fontSize:15,display:"flex",alignItems:"center",gap:6},children:["success"===r?(0,o.jsx)(y.FJM,{color:"green"}):(0,o.jsx)(y.G5m,{color:"red"})," ",a]}),(0,o.jsx)("style",{children:".spin { animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }"})]})}var E=n(166),I=n(8613),D=n(3855),R=n.n(D);async function B(e,t,o){var i;let r;if(console.log("[DEBUG] downloadContractFile contractId:",e),console.log("[DEBUG] downloadContractFile contractTitle:",t),console.log("[DEBUG] downloadContractFile password:",o),!e)throw Error("계약 ID가 없습니다.");if(!t)throw Error("파일명이 없습니다.");if(!o)throw Error("비밀번호가 필요합니다.");let a=localStorage.getItem("userId"),s=a?await (0,w.vm)(a):"";if(!s)throw Error("userId 없음");let{loadPrivateKey:l}=await Promise.resolve().then(n.bind(n,6823)),d=await l(s,o);if(!d)throw console.warn("[DEBUG] downloadContractFile privateKeyPem is undefined or empty!"),alert("개인키를 불러올 수 없습니다. 비밀번호를 확인하세요."),Error("개인키를 불러올 수 없습니다.");console.log("[DEBUG] downloadContractFile - 복호화된 privateKeyPem (앞 50):",d.slice(0,50)),console.log("[DEBUG] downloadContractFile - 복호화된 privateKeyPem 길이:",d.length);let c="";try{let e=await fetch("/api/user/public-key?userId=".concat(s));if(!e.ok)throw Error("공개키 조회 실패");c=(await e.json()).publicKey}catch(e){throw Error("서버에서 공개키를 불러올 수 없습니다.")}let u=function(e){try{let t,n;if(!e)return console.error("[DEBUG] PEM이 비어있음"),{ok:!1,reason:"PEM이 비어있음"};if(!e.startsWith("-----BEGIN RSA PRIVATE KEY-----"))return console.error("[DEBUG] PEM 포맷 이상:",e.slice(0,50)),{ok:!1,reason:"PEM 포맷 이상"};try{t=R().pki.privateKeyFromPem(e)}catch(e){return console.error("[DEBUG] forge.pki.privateKeyFromPem 실패:",e),{ok:!1,reason:"forge.pki.privateKeyFromPem 실패",error:e}}try{let e=R().pki.rsa.setPublicKey(t.n,t.e);n=R().pki.publicKeyToPem(e)}catch(e){return console.error("[DEBUG] 공개키 추출 실패:",e),{ok:!1,reason:"공개키 추출 실패",error:e}}return console.log("[DEBUG] 공개키 추출 성공:",n.slice(0,50)+"..."),{ok:!0,publicKeyPem:n}}catch(e){return console.error("[DEBUG] 예기치 못한 오류:",e),{ok:!1,reason:"예기치 못한 오류",error:e}}}(d),f=null!==(i=u.publicKeyPem)&&void 0!==i?i:"";if(!u.ok)throw alert("개인키에서 공개키 추출 실패: "+u.reason),Error("개인키에서 공개키 추출 실패: "+u.reason);if(console.log("[DEBUG] publicKeyFromPrivate (앞 50):",f.slice(0,50)),console.log("[DEBUG] publicKeyFromDB (앞 50):",c.slice(0,50)),console.log("[DEBUG] 공개키 일치 여부:",f===c),f!==c)throw console.error("[DEBUG] 키 쌍 불일치! 개인키에서 추출한 공개키:",f),console.error("[DEBUG] DB에 저장된 공개키:",c),Error("전자서명 키 쌍이 일치하지 않습니다. 키를 재등록하거나 복구해 주세요.");let g={"x-private-key":btoa(d||""),"Content-Type":"application/json"};if(console.log("[DEBUG] downloadContractFile fetch headers:",g),!d)throw Error("개인키를 불러올 수 없습니다");try{console.log("[DEBUG] downloadContractFile fetch 호출 직전:","/api/contract/".concat(String(null!=e?e:""),"/download")),r=await fetch("/api/contract/".concat(String(null!=e?e:""),"/download"),{headers:g}),console.log("[DEBUG] downloadContractFile fetch 호출 성공:",r)}catch(e){throw console.error("[DEBUG] downloadContractFile fetch 함수 호출에서 예외 발생:",e),e instanceof Error&&e.stack&&console.error("[DEBUG] downloadContractFile fetch 예외 스택:",e.stack),e}if(console.log("[DEBUG] downloadContractFile fetch response status:",r.status),console.log("[DEBUG] downloadContractFile fetch response ok:",r.ok),!r.ok){let e="다운로드 실패";try{let t=await r.json();e=t.message||e,console.error("[DEBUG] downloadContractFile fetch error response:",t)}catch(e){console.error("[DEBUG] downloadContractFile fetch error (not JSON):",e)}throw Error(e)}let p=await r.blob(),h=String(null!=t?t:""),x=document.createElement("a");x.href=URL.createObjectURL(p),x.download=h,document.body.appendChild(x),x.click(),document.body.removeChild(x),URL.revokeObjectURL(x.href)}let z=e=>{switch(e){case"uploaded":return"#ff9800";case"signed":return"#4caf50";case"expired":return"#888888";case"rejected":return"#b71c1c";default:return"#888"}},T=e=>{switch(e){case"uploaded":return"#fff7e6";case"signed":return"#e6f9ed";case"expired":default:return"#f4f4f4";case"rejected":return"#ffebee"}};var W=e=>{let{contract:t,type:n,onPreview:r,onSign:s,onDelete:l}=e;(0,a.useRouter)();let[d,c]=(0,i.useState)(!1),[u,f]=(0,i.useState)(!1),[g,p]=(0,i.useState)(!1),[h,x]=(0,i.useState)(""),[m,v]=(0,i.useState)(!1),[b,w]=(0,i.useState)(""),j=i.useRef(null),S=async()=>{console.log("[DEBUG][ContractListItem] doDownload 함수 진입"),console.log("[DEBUG][ContractListItem] contract:",t),console.log("[DEBUG][ContractListItem] password:",h),v(!0),w("");try{await B(t._id,t.title,h),p(!1),x("")}catch(e){w(e.message||"다운로드 실패"),console.error("[DEBUG][ContractListItem] 다운로드 에러:",e)}finally{v(!1)}};return(0,o.jsxs)("li",{style:{padding:"16px 20px",borderBottom:"1px solid #eee",color:"signed"===t.status?"#4caf50":"black",display:"flex",flexDirection:"column",borderRadius:8,marginBottom:12,background:"#fff",position:"relative",boxShadow:"0 2px 8px #0001",transition:"box-shadow 0.2s"},onMouseOver:e=>e.currentTarget.style.boxShadow="0 4px 16px #1976d233",onMouseOut:e=>e.currentTarget.style.boxShadow="0 2px 8px #0001",children:[(0,o.jsxs)("div",{style:{display:"flex",alignItems:"center",marginBottom:6},children:[(0,o.jsx)("span",{style:{fontWeight:700,fontSize:16,maxWidth:"100%",textOverflow:"ellipsis",overflow:"hidden",whiteSpace:"nowrap",color:"#222",cursor:"received"===n&&"uploaded"===t.status?"pointer":"default",textDecoration:"received"===n&&"uploaded"===t.status?"underline":"none",transition:"text-decoration 0.15s"},title:t.title,onClick:"received"===n&&"uploaded"===t.status&&s?()=>s(t):void 0,onMouseOver:"received"===n&&"uploaded"===t.status?e=>e.currentTarget.style.textDecoration="underline":void 0,onMouseOut:"received"===n&&"uploaded"===t.status?e=>e.currentTarget.style.textDecoration="none":void 0,children:(()=>{var e;let n=(null!==(e=t.title)&&void 0!==e?e:"").replace(/\.[^/.]+$/,"");return n.length>14?n.slice(0,14)+"...":n})()}),(0,o.jsx)("span",{style:{fontSize:13,color:z(t.status),background:T(t.status),borderRadius:6,padding:"2px 10px",fontWeight:600,marginLeft:10,minWidth:60,textAlign:"center",textTransform:"capitalize"},title:t.status,children:t.status})]}),(0,o.jsx)("div",{style:{fontSize:13,color:"#888",marginBottom:6},children:"sent"===n?"수신자: ".concat(t.recipientEmail||"-"):"송신자: ".concat(t.senderEmail||"-")}),(0,o.jsxs)("div",{style:{fontSize:13,color:"#888",marginBottom:6},children:["업로드: ",new Date(t.createdAt).toLocaleString()]}),(0,o.jsxs)("div",{style:{fontSize:13,color:"#888",marginBottom:6},children:["파일명: ",t.filename||t.title]}),(0,o.jsxs)("div",{style:{position:"absolute",top:12,right:20,display:"flex",gap:8},children:[(0,o.jsx)("button",{title:"미리보기",onClick:()=>null==r?void 0:r(t),style:{background:"none",border:"none",cursor:"pointer",padding:4,borderRadius:4,color:"#1976d2",opacity:.7,transition:"opacity 0.2s"},onMouseOver:e=>e.currentTarget.style.opacity="1",onMouseOut:e=>e.currentTarget.style.opacity="0.7",children:(0,o.jsx)(y.U41,{className:"clickable",size:16})}),(0,o.jsx)("button",{title:"다운로드",onClick:()=>p(!0),style:{background:"none",border:"none",cursor:"received"===n&&"signed"!==t.status?"not-allowed":"pointer",padding:4,borderRadius:4,color:"#1976d2",opacity:"received"===n&&"signed"!==t.status?.3:.7,transition:"opacity 0.2s",display:"flex",alignItems:"center"},onMouseOver:"received"===n&&"signed"!==t.status?void 0:e=>e.currentTarget.style.opacity="1",onMouseOut:"received"===n&&"signed"!==t.status?void 0:e=>e.currentTarget.style.opacity="0.7",disabled:"received"===n&&"signed"!==t.status,children:(0,o.jsx)(y.aBF,{size:15})}),(0,o.jsx)("button",{title:"삭제",onClick:()=>f(!0),style:{background:"none",border:"none",cursor:"pointer",padding:4,borderRadius:4,color:"#ff5252",opacity:.7,transition:"opacity 0.2s"},onMouseOver:e=>e.currentTarget.style.opacity="1",onMouseOut:e=>e.currentTarget.style.opacity="0.7",children:(0,o.jsx)(y.AMf,{className:"clickable",size:16})})]}),u&&(0,o.jsx)("div",{style:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",background:"rgba(0,0,0,0.35)",zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center"},children:(0,o.jsxs)("div",{style:{background:"#fff",borderRadius:16,boxShadow:"0 4px 32px #0003",padding:"40px 32px",minWidth:320,maxWidth:"90vw",textAlign:"center",fontSize:18,color:"#222",fontWeight:500,border:"2px solid #1976d2",letterSpacing:.5},children:[(0,o.jsx)("div",{style:{marginBottom:18,fontSize:20,fontWeight:700},children:"계약서 삭제"}),(0,o.jsxs)("div",{style:{marginBottom:24},children:["정말로 이 계약서를 삭제하시겠습니까?",(0,o.jsx)("br",{}),"삭제된 계약서는 복구할 수 없습니다."]}),(0,o.jsxs)("div",{style:{display:"flex",gap:16,justifyContent:"center"},children:[(0,o.jsx)("button",{onClick:async()=>{await fetch("/api/contract/".concat(t._id),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({status:"rejected"})}),f(!1)},style:{background:"#d32f2f",color:"#fff",border:"none",borderRadius:8,padding:"10px 24px",fontSize:16,fontWeight:600,cursor:"pointer"},children:"삭제"}),(0,o.jsx)("button",{onClick:()=>f(!1),style:{background:"#eee",color:"#1976d2",border:"none",borderRadius:8,padding:"10px 24px",fontSize:16,fontWeight:600,cursor:"pointer"},children:"취소"})]})]})}),g&&(0,o.jsx)("div",{style:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",background:"rgba(0,0,0,0.35)",zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center"},children:(0,o.jsxs)("div",{style:{background:"#fff",borderRadius:16,boxShadow:"0 4px 32px #0003",padding:"40px 32px",minWidth:320,maxWidth:"90vw",textAlign:"center",fontSize:18,color:"#222",fontWeight:500,border:"2px solid #1976d2",letterSpacing:.5},children:[(0,o.jsx)("div",{style:{marginBottom:18,fontSize:20,fontWeight:700},children:"계약서 복호화를 위한 비밀번호 입력"}),(0,o.jsx)("input",{ref:j,type:"password",value:h,onChange:e=>x(e.target.value),placeholder:"비밀번호",style:{width:"90%",padding:"10px 12px",fontSize:17,borderRadius:8,border:"1px solid #bbb",marginBottom:16,outline:"none",letterSpacing:1},autoFocus:!0,autoComplete:"current-password",onKeyDown:async e=>{"Enter"===e.key&&S()},disabled:m}),(0,o.jsx)("div",{style:{color:"#d32f2f",minHeight:24,marginBottom:8},children:b||(!1===m&&h&&h.length<6?"비밀번호가 올바르지 않습니다.":"")}),(0,o.jsxs)("div",{style:{display:"flex",gap:16,justifyContent:"center"},children:[(0,o.jsx)("button",{onClick:S,style:{background:"#1976d2",color:"#fff",border:"none",borderRadius:8,padding:"10px 24px",fontSize:16,fontWeight:600,cursor:m?"not-allowed":"pointer",opacity:m?.6:1},disabled:m,children:"확인"}),(0,o.jsx)("button",{onClick:()=>{p(!1),x(""),w("")},style:{background:"#eee",color:"#1976d2",border:"none",borderRadius:8,padding:"10px 24px",fontSize:16,fontWeight:600,cursor:m?"not-allowed":"pointer",opacity:m?.6:1},disabled:m,children:"취소"})]})]})})]},t._id)};let P=(0,E.default)(()=>Promise.all([n.e(489),n.e(996),n.e(528)]).then(n.bind(n,4528)),{loadableGenerated:{webpack:()=>[4528]},ssr:!1});function U(e){let{contracts:t,userId:n,refreshContracts:r}=e,[a,s]=(0,i.useState)(null),[l,d]=(0,i.useState)("sent"),[c,u]=(0,i.useState)(null),[f,g]=(0,i.useState)(!1),[p,h]=(0,i.useState)(null),x=t.filter(e=>e.uploaderId===n&&"expired"!==e.status),y=t.filter(e=>e.recipientId===n&&"rejected"!==e.status&&"expired"!==e.status);i.useEffect(()=>{if(!r)return;let e=setInterval(()=>{r()},1e4);return()=>clearInterval(e)},[r]);let m=e=>{h(e),g(!0)},v=async()=>{p&&(await fetch("/api/contract/".concat(p),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({deletedBy:n})}),r&&r()),g(!1),h(null)};return(0,o.jsxs)("div",{style:{marginTop:30},children:[(0,o.jsx)("div",{style:{margin:"0 0 16px 0",textAlign:"right"},children:(0,o.jsxs)("select",{value:l,onChange:e=>d(e.target.value),style:{padding:"6px 16px",borderRadius:6,border:"1px solid #ccc",fontSize:15,cursor:"pointer"},children:[(0,o.jsx)("option",{value:"sent",children:"송신함"}),(0,o.jsx)("option",{value:"received",children:"수신함"})]})}),(0,o.jsx)("div",{style:{maxWidth:600,margin:"0 auto",background:"#fff",borderRadius:12,boxShadow:"0 2px 16px #0001",padding:0},children:(0,o.jsx)("ul",{style:{listStyle:"none",padding:"8px 0",minHeight:120,maxHeight:350,overflowY:"auto",border:"1px solid #e0e0e0",borderRadius:8,background:"#fff",margin:0},children:"sent"===l?0===x.length?(0,o.jsx)("li",{style:{paddingLeft:20,paddingTop:24,paddingBottom:24,color:"#888",fontSize:16,textAlign:"center"},children:"보낸 계약서가 없습니다."}):x.map(e=>(0,o.jsx)(W,{contract:e,type:"sent",onPreview:()=>s(e),onDelete:m},e._id)):0===y.length?(0,o.jsx)("li",{style:{paddingLeft:20,paddingTop:24,paddingBottom:24,color:"#888",fontSize:16,textAlign:"center"},children:"받은 계약서가 없습니다."}):y.map(e=>(0,o.jsx)(W,{contract:e,type:"received",onPreview:()=>s(e),onSign:()=>u(e),onDelete:m},e._id))})}),a&&(0,o.jsx)("div",{style:{position:"fixed",left:0,top:0,width:"100vw",height:"100vh",background:"rgba(0,0,0,0.25)",zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center"},onClick:()=>s(null),children:(0,o.jsx)("div",{style:{background:"#fff",borderRadius:12,padding:32,minWidth:480,boxShadow:"0 4px 24px #0002",textAlign:"center",position:"relative"},onClick:e=>e.stopPropagation(),children:(0,o.jsx)(P,{contract:a,onClose:()=>{s(null),r&&r()},type:l})})}),c&&(0,o.jsx)(I.Z,{contract:c,onComplete:()=>{u(null),r&&r()},onClose:()=>u(null)}),f&&(0,o.jsx)("div",{style:{position:"fixed",left:0,top:0,width:"100vw",height:"100vh",background:"rgba(0,0,0,0.35)",zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center"},children:(0,o.jsxs)("div",{style:{background:"#fff",borderRadius:12,padding:32,minWidth:320,boxShadow:"0 4px 24px #0002",textAlign:"center",position:"relative"},children:[(0,o.jsx)("div",{style:{fontWeight:600,marginBottom:16},children:"정말 삭제하시겠습니까?"}),(0,o.jsx)("button",{style:{background:"#1976d2",color:"#fff",border:"none",borderRadius:6,padding:"8px 24px",fontWeight:600,fontSize:16,cursor:"pointer",marginRight:8},onClick:v,children:"확인"}),(0,o.jsx)("button",{style:{background:"#eee",color:"#333",border:"none",borderRadius:6,padding:"8px 24px",fontWeight:500,fontSize:16,cursor:"pointer"},onClick:()=>{g(!1),h(null)},children:"취소"})]})})]})}var G=n(1130),K=n(7635),O=n.n(K),A=n(3837),N=n(3519);function F(){let[e,t]=(0,i.useState)(null),{showConfirmModal:n,setShowConfirmModal:r,showQrModal:a,setShowQrModal:s,showSignModal:d,setShowSignModal:c}=function(){let[e,t]=(0,i.useState)(!1),[n,o]=(0,i.useState)(!1),[r,a]=(0,i.useState)(!1);return{showConfirmModal:e,setShowConfirmModal:t,showQrModal:n,setShowQrModal:o,showSignModal:r,setShowSignModal:a}}(),[u,f]=(0,i.useState)(""),[g,h]=(0,i.useState)(!1),[x,y]=(0,i.useState)(null),[m,v]=(0,i.useState)(""),[b,w]=(0,i.useState)(""),[S,E]=(0,i.useState)(null),[I,D]=(0,i.useState)(""),[R,B]=(0,i.useState)("idle"),[z,T]=(0,i.useState)("idle"),[W,P]=(0,i.useState)(""),[K,F]=(0,i.useState)(""),[M,L]=(0,i.useState)(null),{contracts:H,refreshContracts:Q}=(0,G.z)(),[Z,q]=(0,i.useState)(!0),[J,_]=(0,i.useState)(!1),{notifications:V,unreadCount:X,setNotifications:Y,setUnreadCount:$,refreshNotifications:ee}=function(){let[e,t]=(0,i.useState)([]),[n,o]=(0,i.useState)(0),r=async()=>{let e=await fetch("/api/auth/notifications",{credentials:"include"});if(e.ok){let n=await e.json();t(n.notifications),o((n.notifications||[]).filter(e=>!e.read).length)}};return(0,i.useEffect)(()=>{let e=!1;async function n(){try{await r()}catch(n){e||(t([]),o(0))}}n();let i=setInterval(n,3e4);return()=>{e=!0,clearInterval(i)}},[]),{notifications:e,unreadCount:n,setNotifications:t,setUnreadCount:o,refreshNotifications:r}}();(0,i.useEffect)(()=>{fetch("/api/user/me").then(e=>e.json()).then(e=>L(e))},[]),(0,i.useEffect)(()=>{q(!0),Q().finally(()=>q(!1))},[Q]),(0,i.useEffect)(()=>{fetch("/api/user/me").then(e=>{(401===e.status||403===e.status)&&(window.location.href="/login")})},[]);let et=async e=>{let t=e.target.value;if(D(t),B("checking"),!/^[\w-.]+@[\w-]+\.[a-zA-Z]{2,}$/.test(t)){B("invalid"),F("이메일 형식에 맞지 않습니다.");return}if(M&&t.trim().toLowerCase()===M.email.trim().toLowerCase()){B("invalid"),F("본인 이메일로는 보낼 수 없습니다.");return}try{let e=await fetch("/api/user/check-email?email=".concat(encodeURIComponent(t)));(await e.json()).exists?(B("valid"),F("등록된 이메일입니다.")):(B("invalid"),F("등록되지 않은 이메일입니다."))}catch(e){B("invalid"),F("이메일 확인 중 오류 발생")}},en=async e=>{if(e.preventDefault(),!S){T("error"),P("파일을 선택하세요.");return}T("uploading");let t=new(O());t.file(S.name,S);let n=await t.generateAsync({type:"blob"}),o=(0,A.Z)()+".zip",i=new FormData;i.append("file",n,o),i.append("recipientEmail",I);try{let e;console.log("Uploading contract...");let t=await fetch("/api/contract/upload",{method:"POST",body:i});console.log("Upload response:",t);let n=await t.text();try{e=JSON.parse(n),console.log("Upload response data:",e)}catch(e){console.error("Upload error (raw text):",n),T("error"),P("업로드 중 오류 발생: "+n);return}t.ok?(T("success"),P(e.message||"성공적으로 계약서를 수신했습니다."),E(null),D("")):(T("error"),P(e.message||"업로드 실패"))}catch(e){console.error("Upload error:",e),T("error"),P("업로드 중 오류 발생")}},eo=async()=>{if(f("SHA-256 해시 비교 중..."),e)try{var t,n,o;let i=e.contractId||(null===(t=e.message.match(/contractId:([\w\d]+)/))||void 0===t?void 0:t[1]);if(!i){f("계약 ID를 찾을 수 없습니다.");return}if(!/^[0-9a-fA-F]{24}$/.test(i)){f("잘못된 계약 ID입니다.");return}let a=await fetch("/api/contract/".concat(i,"/hash")),l=await a.json();y(i),v(l.hash);let d=await fetch("/api/contract/receive",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({contractId:i})}),c=await d.json();c.hashValid||(null===(n=c.message)||void 0===n?void 0:n.includes("무결성"))||(null===(o=c.message)||void 0===o?void 0:o.includes("수신함"))?(f("무결성 검증 완료"),await Q(),setTimeout(()=>{r(!1),s(!0),f("")},1200)):f("해시 불일치! 파일이 변조되었습니다.")}catch(e){f("수신 처리 중 오류가 발생했습니다.")}},ei=()=>{h(!0),setTimeout(()=>{s(!1),c(!0)},1e3)};return Z?(0,o.jsx)(N.Z,{}):(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)(j,{onMessageAction:Q}),n&&e&&(0,o.jsx)(l.Z,{message:(()=>{let t=e.filename||e.title||"계약서";return"".concat(t,"계약서가 도착했습니다. 수신하시겠습니까?")})(),onConfirm:eo,integrityMsg:u}),a&&(()=>{var e;console.log("==========[QR MODAL DEBUG]=========="),console.log("[DEBUG] contracts.length:",H.length),console.log("[DEBUG] contracts:",H),console.log("[DEBUG] signContractId:",x);let t=H.map(e=>({...e,signed:!!e.signed})).find(e=>e._id===x);return console.log("[DEBUG] foundContract:",t),t?(console.log("[DEBUG] foundContract.signature:",t.signature),t.signature?(console.log("[DEBUG] foundContract.signature.qrCode:",t.signature.qrCode),t.signature.qrCode||console.error("[DEBUG] foundContract.signature.qrCode가 없습니다!")):console.error("[DEBUG] foundContract.signature가 없습니다!")):console.error("[DEBUG] contracts 배열에 해당 contract가 없습니다!"),(0,o.jsx)(p.Z,{onQrSuccess:ei,qrVerified:g,qrCode:(null==t?void 0:null===(e=t.signature)||void 0===e?void 0:e.qrCode)||"",contractId:x||""})})(),d&&x&&m&&(0,o.jsx)(C,{signContractId:x,signContractHash:m,onSigned:()=>{w("서명이 성공적으로 완료되었습니다!"),setTimeout(()=>{c(!1),w(""),Q()},1500)},signStatus:b}),(0,o.jsxs)("div",{className:"card",children:[(0,o.jsx)("h1",{children:"디지털 계약서"}),(0,o.jsx)(k,{file:S,recipientEmail:I,emailStatus:R,uploadStatus:z,uploadMsg:W,handleUpload:en,handleFileChange:e=>{E(e.target.files&&e.target.files[0]||null),P("")},handleRecipientEmailChange:et,emailMsg:K,user:M}),(0,o.jsx)("button",{className:"clickable",style:{margin:"24px 0",padding:"10px 24px",fontSize:16,background:"#1976d2",color:"#fff",border:"none",borderRadius:8,transition:"background 0.18s, box-shadow 0.18s",boxShadow:void 0,cursor:"pointer"},onClick:()=>_(e=>!e),onMouseOver:e=>e.currentTarget.style.boxShadow="0 4px 16px rgba(25, 118, 210, 0.18)",onMouseOut:e=>e.currentTarget.style.boxShadow="",children:"계약서 목록"}),J&&(null==M?void 0:M.userId)&&(0,o.jsx)(U,{contracts:H.map(e=>({...e,signed:!!e.signed})),userId:String(M.userId),refreshContracts:Q})]})]})}},4335:function(e,t,n){"use strict";n.d(t,{Z:function(){return i}});var o=n(7437);function i(e){let{message:t,onConfirm:n,onCancel:i,integrityMsg:r="",children:a,confirmLabel:s="확인",cancelLabel:l="취소"}=e;return(0,o.jsx)("div",{className:"confirm-modal-backdrop",style:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",background:"#0008",zIndex:2e3,display:"flex",alignItems:"center",justifyContent:"center"},children:(0,o.jsxs)("div",{style:{background:"#fff",borderRadius:10,padding:32,minWidth:320,boxShadow:"0 2px 16px #0003"},onClick:e=>e.stopPropagation(),children:[(0,o.jsxs)("div",{style:{marginBottom:18},children:[(0,o.jsx)("b",{children:t}),a]}),(0,o.jsx)("div",{style:{display:"flex",gap:12,marginBottom:10,justifyContent:"center"},children:(0,o.jsx)("button",{onClick:n,style:{background:"#1976d2",color:"#fff",border:"none",borderRadius:6,padding:"8px 18px",fontWeight:500},children:s})}),r&&(0,o.jsx)("div",{style:{color:r.includes("완료")?"green":"red",fontWeight:600},children:r})]})})}n(2265)},8613:function(e,t,n){"use strict";n.d(t,{Z:function(){return v}});var o=n(7437),i=n(2265),r=n(5801),a=n(9655),s=n(3566),l=n.n(s),d=n(8598),c=n.n(d),u=n(3855),f=n.n(u),g=n(6823),p=n(4260),h=n(4335),x=n(9376);function y(e){let{onSubmit:t,error:n}=e,[r,a]=(0,i.useState)(""),[s,l]=(0,i.useState)("");return(0,o.jsx)("div",{style:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",background:"#0008",display:"flex",alignItems:"center",justifyContent:"center",zIndex:9999},children:(0,o.jsxs)("div",{style:{background:"#fff",padding:32,borderRadius:12,minWidth:320},children:[(0,o.jsx)("h2",{children:"전자서명 비밀번호 입력"}),(0,o.jsxs)("div",{style:{fontSize:15,color:"#555",marginBottom:10},children:["이 비밀번호는 ",(0,o.jsx)("b",{children:"회원가입 마지막 단계(OTP 인증)"}),"에서 입력한 비밀번호입니다.",(0,o.jsx)("br",{}),(0,o.jsx)("b",{children:"전자서명, 파일 복호화"})," 등 중요한 작업에 사용되니 정확히 입력해 주세요.",(0,o.jsx)("br",{}),(0,o.jsx)("span",{style:{color:"#d32f2f",fontWeight:500},children:"로그인/회원가입 비밀번호와 다를 수 있습니다."})]}),(0,o.jsx)("input",{type:"password",value:r,onChange:e=>{a(e.target.value),l(""),console.log("[DEBUG] PasswordModal input:",e.target.value)},style:{width:"100%",padding:10,marginBottom:12,borderRadius:6,border:"1px solid #ccc"},placeholder:"OTP 인증/회원가입 시 입력한 비밀번호 (파일 복호화에도 사용)"}),(s||n)&&(0,o.jsx)("div",{style:{color:"red",marginBottom:8},children:s||n||"비밀번호가 올바르지 않습니다."}),(0,o.jsx)("button",{style:{width:"100%",padding:10,borderRadius:6,background:"#1976d2",color:"#fff",border:"none"},onClick:()=>{if(!r||r.length<6){l("비밀번호를 올바르게 입력하세요."),console.log("[DEBUG] PasswordModal submit: too short or empty",r);return}console.log("[DEBUG] PasswordModal submit:",r),t(r)},children:"확인"})]})})}var m=n(9274),v=e=>{var t;let{contract:s,onComplete:d,onClose:u}=e,[v,b]=(0,i.useState)("hash"),[w,j]=(0,i.useState)(!1),[S,C]=(0,i.useState)(""),[k,E]=(0,i.useState)(""),[I,D]=(0,i.useState)(""),[R,B]=(0,i.useState)(!1),z=(0,i.useRef)(null),[T,W]=(0,i.useState)(!1),P=(0,x.useRouter)(),[U,G]=(0,i.useState)(""),[K,O]=(0,i.useState)(!1),[A,N]=(0,i.useState)(!1),[F,M]=(0,i.useState)(""),[L,H]=(0,i.useState)(""),[Q,Z]=(0,i.useState)(null),[q,J]=(0,i.useState)(null),[_,V]=(0,i.useState)(null);i.useEffect(()=>{"hash"===v&&(j(!0),C("SHA-256 해시 비교 중..."),fetch("/api/contract/".concat(s._id)).then(e=>e.json()).then(e=>{var t,n,o,i;console.log("[해시 검증] 서버 fileHash:",null===(t=e.security)||void 0===t?void 0:t.fileHash,"프론트 contract.fileHash:",null===(n=s.security)||void 0===n?void 0:n.fileHash),j(!1),(null===(o=e.security)||void 0===o?void 0:o.fileHash)===(null===(i=s.security)||void 0===i?void 0:i.fileHash)?(C("무결성 검증 완료! 다음 단계로 이동합니다."),setTimeout(()=>{b("qr"),C("QR 코드 인증 단계로 이동합니다.")},1e3)):C("무결성 검증 실패: 파일이 변조되었습니다.")}).catch(()=>{C("무결성 검증 중 오류 발생"),j(!1)}))},[v,s]);let X=async e=>{try{let t=localStorage.getItem("userId");console.log("[DEBUG] encryptedUserId:",t);let o=t?await (0,m.vm)(t):"";console.log("[DEBUG] decrypted userId:",o);let i=await (await Promise.resolve().then(n.bind(n,6823))).getDB(),r=await i.getAllKeys("privateKeys");console.log("[DEBUG] IndexedDB allKeys:",r);let a=await i.get("privateKeys",o);console.log("[DEBUG] IndexedDB encrypted privateKey:",a);let{loadPrivateKey:s}=await Promise.resolve().then(n.bind(n,6823)),l=await s(o,e);return console.log("[DEBUG] loadPrivateKey result:",l),{userId:o,privateKeyPem:l,encrypted:a}}catch(e){return console.error("[DEBUG] debugLog error:",e),{}}},Y=async e=>{await X(e),E("공개키 일치 확인 중..."),H(""),N(!1);try{let t=await fetch("/api/contract/".concat(s._id)),n=await t.json();if(n.expiryDate&&new Date(n.expiryDate)<new Date){E("계약 유효기간이 만료되었습니다."),setTimeout(()=>E(""),1500),b("idle");return}let o=localStorage.getItem("userId")||"",i=o?await (0,m.vm)(o):"";if(!e||e.length<6){H("비밀번호가 올바르지 않습니다."),E(""),N(!0);return}let r=await (0,g.loadPrivateKey)(i,e);setTimeout(()=>{E("개인키 일치 확인 중..."),setTimeout(()=>{var t;if(!r){H("개인키를 찾을 수 없습니다. (비밀번호가 틀렸거나, 개인키가 손상/삭제되었을 수 있습니다. OTP 인증(회원가입 마지막 단계)에서 입력한 비밀번호를 입력하세요.)"),E(""),N(!0),console.log("[DEBUG] handleSignWithPassword: privateKeyPem is undefined/null");return}let n=f().pki.privateKeyFromPem(r),o=f().md.sha256.create();o.update(null===(t=s.security)||void 0===t?void 0:t.fileHash,"utf8");let i=f().util.encode64(n.sign(o));Z(i),J(e),V(r),E("전자서명 성공! 공개키/개인키 일치"),setTimeout(()=>{b("hand"),E("손글씨 서명 단계로 이동합니다.")},1e3)},1e3)},1e3)}catch(e){E("전자서명 실패: "+((null==e?void 0:e.message)||String(e))),b("idle"),console.log("[DEBUG] handleSignWithPassword: exception",e)}},$=async()=>{D("손글씨 서명 처리 중...");try{var e,t,n;let o=null===(e=z.current)||void 0===e?void 0:e.toDataURL("image/png");if(!o)throw Error("서명 데이터 없음");let i=l()(o).toString(c());if(!_)throw Error("전자서명 정보 없음");let r=f().pki.privateKeyFromPem(_),a=f().md.sha256.create();a.update(i,"utf8");let u=f().util.encode64(r.sign(a));console.log("[DEBUG] PATCH body:",{fileSignature:Q,contractHash:null===(t=s.security)||void 0===t?void 0:t.fileHash,signatureImage:o,signatureImageHash:i,signatureImageHashSignature:u,signer:(null==s?void 0:s.signer)||""});let g=localStorage.getItem("userId")||"",p=g?await (0,m.vm)(g):"",h=await fetch("/api/contract/".concat(s._id),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({contractHash:null===(n=s.security)||void 0===n?void 0:n.fileHash,signature:Q,signatureImage:o,signatureImageHash:i,signatureImageHashSignature:u,signer:p})}),x=await h.json().catch(()=>({}));if(!h.ok){D("손글씨 서명 실패: "+(x.message||"서버 오류")),b("idle"),console.log("[DEBUG] handleHandSign: signRes not ok",x);return}D("서명이 성공적으로 완료되었습니다"),s.status="signed",b("done"),setTimeout(()=>{d&&d()},1500)}catch(e){D("손글씨 서명 실패: "+((null==e?void 0:e.message)||String(e))),b("idle"),console.log("[DEBUG] handleHandSign: exception",e)}};return(0,i.useEffect)(()=>{("expired"===s.status||"rejected"===s.status||"signed"!==s.status&&"uploaded"!==s.status)&&W(!0)},[s.status]),(0,o.jsxs)("div",{style:{position:"fixed",left:0,top:0,width:"100vw",height:"100vh",background:"rgba(0,0,0,0.25)",zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center"},children:["hash"===v&&(0,o.jsxs)("div",{style:{background:"#fff",borderRadius:12,padding:32,minWidth:340,boxShadow:"0 4px 24px #0002",textAlign:"center",position:"relative"},children:[(0,o.jsx)("div",{style:{fontWeight:600,marginBottom:16},children:s.title}),(0,o.jsx)("div",{style:{marginBottom:16},children:w?(0,o.jsxs)("span",{style:{display:"flex",alignItems:"center",color:"#1976d2"},children:[(0,o.jsx)(p.fCD,{className:"spin",style:{marginRight:8}}),"계약서 무결성 검증 중입니다..."]}):S.includes("완료")?(0,o.jsxs)("span",{style:{display:"flex",alignItems:"center",color:"#1976d2"},children:[(0,o.jsx)(p.FJM,{style:{marginRight:8}}),S]}):S.includes("실패")?(0,o.jsxs)("span",{style:{display:"flex",alignItems:"center",color:"#d32f2f"},children:[(0,o.jsx)(p.gJy,{style:{marginRight:8}}),S]}):S}),(0,o.jsx)("button",{onClick:u,style:{marginTop:8,background:"#eee",color:"#333",border:"none",borderRadius:6,padding:"8px 24px",fontWeight:500,fontSize:16,cursor:"pointer"},children:"닫기"})]}),"qr"===v&&(0,o.jsxs)("div",{style:{background:"#fff",borderRadius:12,padding:32,minWidth:340,boxShadow:"0 4px 24px #0002",textAlign:"center",position:"relative"},children:[(0,o.jsx)("div",{style:{fontWeight:600,marginBottom:16},children:s.title}),(0,o.jsx)("div",{style:{marginBottom:16},children:"QR 인증이 필요합니다. 아래 QR 코드를 스캔해 본인인증을 완료해주세요."}),(0,o.jsx)(r.Z,{onQrSuccess:()=>{B(!0),C("QR 인증 성공!"),setTimeout(()=>{b("sign"),C("전자서명 단계로 이동합니다.")},1e3)},qrVerified:R,qrCode:(null===(t=s.signature)||void 0===t?void 0:t.qrCode)||"",contractId:s._id}),k&&k.includes("QR")&&(0,o.jsxs)("div",{style:{color:"#d32f2f",background:"#fff",border:"1.5px solid #ffbdbd",borderRadius:8,padding:18,margin:"24px 0 0 0",fontWeight:600,fontSize:16,boxShadow:"0 2px 12px #0001",textAlign:"center"},role:"alert",children:["❌ QR 코드 인증 실패",(0,o.jsx)("br",{}),"잘못된 QR 코드입니다. 올바른 계약서의 QR 코드를 다시 스캔해 주세요.",(0,o.jsx)("br",{}),(0,o.jsx)("button",{style:{marginTop:16,background:"#1976d2",color:"#fff",border:"none",borderRadius:6,padding:"8px 18px",fontWeight:500,cursor:"pointer"},onClick:()=>b("qr"),children:"다시 시도"})]})]}),("sign"===v||"hand"===v||"done"===v)&&(0,o.jsx)(a.Z,{step:"sign"===v?"sign":"hand"===v?"hand":"done",signStatus:k,handStatus:I,onSign:()=>{N(!0),H(""),M("")},onHandSign:$,sigCanvasRef:z,clearSig:()=>{var e;return null===(e=z.current)||void 0===e?void 0:e.clear()},isValid:null,onClose:u}),"done"===v&&(0,o.jsx)("div",{style:{position:"absolute",left:0,top:0,width:"100vw",height:"100vh",background:"rgba(0,0,0,0.25)",zIndex:1e4,display:"flex",alignItems:"center",justifyContent:"center"},children:(0,o.jsxs)("div",{style:{background:"#fff",borderRadius:12,padding:32,minWidth:340,boxShadow:"0 4px 24px #0002",textAlign:"center",position:"relative"},children:[(0,o.jsxs)("div",{style:{fontWeight:700,fontSize:18,color:"#1976d2",marginBottom:12,display:"flex",alignItems:"center",justifyContent:"center",gap:8},children:[(0,o.jsx)(p.FJM,{style:{marginRight:8}}),(0,o.jsx)("span",{children:"서명이 성공적으로 완료되었습니다"})]}),(0,o.jsx)("button",{style:{background:"#1976d2",color:"#fff",border:"none",borderRadius:6,padding:"8px 24px",fontWeight:600,fontSize:16,cursor:"pointer",marginTop:8},onClick:u,children:"닫기"})]})}),T&&(0,o.jsx)(h.Z,{message:"expired"===s.status?"계약서가 만료되었습니다. 만료일을 연장하시겠습니까?":"rejected"===s.status?"계약서가 거부/반려되었습니다.":"계약서 상태로 인해 서명할 수 없습니다.",onConfirm:()=>{W(!1),O(!0)},onCancel:()=>{W(!1),P.push("/contract")}}),K&&(0,o.jsx)(h.Z,{message:"만료일을 연장하시겠습니까?",onConfirm:()=>{O(!1),W(!1),O(!0)},onCancel:()=>{O(!1),P.push("/contract")}}),A&&(0,o.jsx)(y,{onSubmit:e=>Y(e),error:L})]})}},6181:function(e,t,n){"use strict";var o=n(7437),i=n(2265),r=n(8677),a=n(6823),s=n(3855),l=n.n(s),d=n(9274);t.Z=e=>{let{contractId:t,contractHash:n,onSigned:s,canSign:c=!0}=e,u=(0,i.useRef)(null),[f,g]=(0,i.useState)(""),[p,h]=(0,i.useState)(""),[x,y]=(0,i.useState)(""),m=async()=>{let e=await fetch("/api/contract/".concat(t)),o=await e.json();if(new Date(o.expirationDate)<new Date){console.log("계약서 만료:",o.expirationDate),h("계약서가 만료되었습니다. 서명할 수 없습니다.");return}if(!f){h("서명자 이름을 입력하세요.");return}if(!x){h("손글씨 서명을 입력하세요.");return}let i=localStorage.getItem("userId")||"",r=i?await (0,d.vm)(i):"",c=prompt("비밀번호를 입력하세요")||"",p=await (0,a.loadPrivateKey)(r,c);if(console.log("서명에 사용할 개인키:",p),!p){h("개인키를 찾을 수 없습니다.");return}let m=l().pki.privateKeyFromPem(p),v=l().md.sha256.create();v.update(n,"utf8");let b=l().util.encode64(m.sign(v)),w=l().md.sha256.create();w.update(x,"utf8");let j=l().util.encode64(m.sign(w));if(console.log("계약서 해시값:",n),console.log("손글씨 해시값:",x),console.log("계약서 해시 서명:",b),console.log("손글씨 해시 서명:",j),(await fetch("/api/contract/".concat(t),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({fileSignature:b,signImageSignature:j,contractHash:n,signImageHash:x,signer:f})})).ok){var S;h("서명 성공!"),console.log("서명 성공! uploaded → signed 상태 변경"),null===(S=u.current)||void 0===S||S.clear(),g(""),y(""),s&&s()}else h("서명 실패")};return(0,o.jsxs)("div",{style:{margin:"32px 0",padding:32,background:"#f8fafd",borderRadius:16,boxShadow:"0 2px 8px #0001",minWidth:480},children:[(0,o.jsx)("h3",{style:{marginBottom:20,fontSize:26},children:"✍️ 계약서 서명"}),(0,o.jsx)("input",{type:"text",placeholder:"서명자 이름",value:f,onChange:e=>g(e.target.value),style:{padding:"12px",width:"100%",marginBottom:"16px",fontSize:18}}),(0,o.jsx)(r.Z,{penColor:"black",canvasProps:{width:1e3,height:400,className:"sigCanvas"},ref:u,backgroundColor:"#f0f0f0",onEnd:()=>{var e;let t=null===(e=u.current)||void 0===e?void 0:e.toDataURL();t&&y(t)}}),(0,o.jsxs)("div",{style:{marginTop:"16px",display:"flex",gap:"16px",justifyContent:"center"},children:[(0,o.jsx)("button",{onClick:()=>{var e;null===(e=u.current)||void 0===e||e.clear(),y("")},style:{padding:"12px 24px",backgroundColor:"#757575",color:"#fff",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:18},children:"지우기"}),(0,o.jsx)("button",{onClick:m,style:{padding:"12px 24px",backgroundColor:"#8bc34a",color:"#fff",border:"none",borderRadius:"8px",cursor:c?"pointer":"not-allowed",fontSize:18},disabled:!c,children:"서명 제출"})]}),p&&(0,o.jsx)("p",{style:{marginTop:"16px",fontSize:18},children:p})]})}},3519:function(e,t,n){"use strict";var o=n(7437);n(2265),n(1551),t.Z=()=>(0,o.jsx)("div",{className:"spinner-overlay",children:(0,o.jsx)("div",{className:"spinner"})})},9743:function(e,t,n){"use strict";n.d(t,{I:function(){return a}});var o=n(7437),i=n(2265),r=n(9274);function a(e){if(!e||"string"!=typeof e||!e.includes(":"))return e||"";try{return(0,r.LJ)(e)}catch(e){return""}}t.Z=e=>{let{notifications:t,loading:n,selectedId:r,onNotificationClick:a,filter:s,setFilter:l,onRead:d,onDelete:c}=e,u=async(e,t)=>{if(t.read)try{await fetch("/api/auth/notifications",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e})}),d&&d(e)}catch(e){}else try{await fetch("/api/auth/notifications",{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({id:e})}),d&&d(e)}catch(e){}setTimeout(()=>{a({...t,read:!0})},0)};t.filter(e=>!e.read).length;let[f,g]=(0,i.useState)([]);return(0,o.jsx)("div",{style:{minWidth:340},children:n?(0,o.jsx)("div",{style:{color:"#888",padding:16},children:"불러오는 중..."}):0===t.length?(0,o.jsx)("div",{style:{color:"#888",padding:16},children:"알림이 없습니다."}):(0,o.jsx)("ul",{style:{listStyle:"none",padding:0,margin:0},children:t.filter(e=>!f.includes(e.id)).map(e=>(0,o.jsx)("li",{onClick:t=>{t.stopPropagation(),g(t=>[...t,e.id]),e.read||u(e.id,e),a({...e,read:!0})},style:{background:e.read?"#f7f7f7":"#e3f0ff",color:e.read?"#888":"#1976d2",fontWeight:e.read?400:600,borderLeft:e.read?"4px solid #ccc":"4px solid #1976d2",padding:"0 16px",marginBottom:16,borderRadius:16,cursor:e.read?"default":"pointer",boxShadow:r===e.id?"0 2px 8px #1976d233":"0 1px 2px #0001",display:"flex",flexDirection:"row",alignItems:"center",position:"relative",transition:"background 0.2s, color 0.2s",opacity:e.read?.7:1,minWidth:340,fontFamily:"inherit",fontSize:17,height:60,overflow:"hidden"},children:(0,o.jsx)("span",{style:{flex:1,display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",overflow:"hidden",textOverflow:"ellipsis",color:e.read?"#888":"#1976d2",fontWeight:e.read?400:600,fontSize:17,paddingLeft:2,paddingRight:8,lineHeight:"1.4",maxHeight:"2.8em",wordBreak:"break-all"},title:e.message,children:e.message})},e.id))})})}},9655:function(e,t,n){"use strict";var o=n(7437);n(2265);var i=n(8677);t.Z=e=>{let{step:t,signStatus:n,handStatus:r,onSign:a,onHandSign:s,sigCanvasRef:l,clearSig:d,isValid:c,onClose:u}=e;return(0,o.jsx)("div",{style:{position:"fixed",left:0,top:0,width:"100vw",height:"100vh",background:"rgba(0,0,0,0.25)",zIndex:9999,display:"flex",alignItems:"center",justifyContent:"center"},children:(0,o.jsxs)("div",{style:{background:"#fff",borderRadius:16,padding:48,minWidth:480,boxShadow:"0 4px 32px #0002",textAlign:"center",position:"relative"},children:["sign"===t&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("div",{style:{fontSize:24,fontWeight:700,marginBottom:24},children:"전자서명"}),(0,o.jsx)("div",{style:{marginBottom:24,fontSize:18},children:"개인키로 전자서명을 진행합니다."}),(0,o.jsx)("button",{style:{background:"#1976d2",color:"#fff",border:"none",borderRadius:6,padding:"8px 24px",fontWeight:600,fontSize:16,cursor:"pointer",marginRight:8},onClick:a,children:"전자서명"}),n&&(0,o.jsx)("div",{style:{marginTop:12,color:n.includes("완료")?"green":"#888"},"aria-live":"polite",children:n})]}),"hand"===t&&(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("div",{style:{fontSize:24,fontWeight:700,marginBottom:24},children:"손글씨 서명"}),(0,o.jsx)("div",{style:{marginBottom:24,fontSize:18},children:"아래에 손글씨로 서명해 주세요."}),(0,o.jsx)("div",{style:{margin:"0 auto 16px",background:"#f4f4f4",borderRadius:8,border:"1px solid #eee",width:320,height:120},children:(0,o.jsx)(i.Z,{ref:l,penColor:"#1976d2",backgroundColor:"#f4f4f4",canvasProps:{width:320,height:120,style:{borderRadius:8}}})}),(0,o.jsx)("button",{style:{background:"#1976d2",color:"#fff",border:"none",borderRadius:6,padding:"8px 24px",fontWeight:600,fontSize:16,cursor:"pointer",marginRight:8},onClick:s,children:"손글씨 서명 제출"}),(0,o.jsx)("button",{style:{background:"#eee",color:"#333",border:"none",borderRadius:6,padding:"8px 24px",fontWeight:500,fontSize:16,cursor:"pointer",marginLeft:8},onClick:d,children:"지우기"}),r&&(0,o.jsx)("div",{style:{marginTop:10,color:r.includes("완료")?"green":"#888"},children:r})]}),"validating"===t&&(0,o.jsx)("div",{style:{fontSize:22,color:"#0074ff",fontWeight:600},children:"계약 유효기간 체크 중..."}),"done"===t&&(0,o.jsx)("div",{style:{fontSize:26,color:"#009e3c",fontWeight:700},children:"서명이 성공적으로 완료되었습니다!"}),(0,o.jsx)("button",{style:{marginTop:20},onClick:u,children:"닫기"})]})})}},5801:function(e,t,n){"use strict";n.d(t,{Z:function(){return s}});var o=n(7437),i=n(2265),r=n(8555),a=n(5398);function s(e){let{onQrSuccess:t,qrVerified:n,qrCode:s,contractId:l}=e;return(0,i.useEffect)(()=>{console.log("[QrModal] contractId:",l),console.log("[QrModal] qrCode:",s),s||console.warn("[QrModal] qrCode가 빈 값입니다. 상위 컴포넌트에서 contracts, signContractId, foundContract, foundContract.signature.qrCode를 콘솔로 찍어 원인을 추적하세요.")},[l,s]),(0,o.jsx)("div",{style:{position:"fixed",top:0,left:0,width:"100vw",height:"100vh",background:"#0008",zIndex:2100,display:"flex",alignItems:"center",justifyContent:"center"},children:(0,o.jsxs)("div",{style:{background:"#fff",borderRadius:16,padding:48,minWidth:480,boxShadow:"0 2px 24px #0003",textAlign:"center",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"},children:[(0,o.jsx)("h2",{style:{fontSize:28,marginBottom:24},children:"QR 코드 인증"}),(0,o.jsx)("div",{style:{marginBottom:32},children:(0,o.jsx)(a.Q,{value:s||"no-qr",size:180})}),(0,o.jsx)(r.Z,{contractId:l,onSuccess:t}),n&&(0,o.jsx)("div",{style:{color:"green",marginTop:24,fontSize:20},children:"인증 성공! 서명 단계로 이동합니다..."})]})})}},8555:function(e,t,n){"use strict";var o=n(7437),i=n(2265),r=n(6324),a=n(3464);t.Z=e=>{let{contractId:t,onSuccess:n}=e,[s,l]=(0,i.useState)(""),[d,c]=(0,i.useState)(null),u=async()=>{if(!d||!d.trim()){l("QR 코드가 인식되지 않았습니다. 이미지를 다시 업로드해 주세요."),console.log("[QR 확인 실패] 스캔 데이터 없음");return}try{console.log("[QR 확인 요청] contractId:",t,"qrCode:",d.trim());let e=await a.Z.post("/api/Qr/verify-qr",{contractId:t,qrCode:d.trim()});console.log("[QR 확인 응답]",e.data),e.data.success?(l("인증 성공! 서명 단계로 이동합니다..."),n&&n(d)):(l(e.data.message||"QR 코드 인증 실패: 올바른 QR 코드가 아닙니다."),console.log("[QR 인증 실패]",e.data))}catch(t){var e,o;l((null==t?void 0:null===(o=t.response)||void 0===o?void 0:null===(e=o.data)||void 0===e?void 0:e.message)||"QR 코드 인증 실패: 서버 오류"),console.log("[QR 인증 예외]",t)}};return(0,o.jsxs)("div",{style:{minWidth:320,maxWidth:400,margin:"0 auto",padding:32,background:"#fff",borderRadius:16,boxShadow:"0 2px 16px #e3e8f7",border:"1px solid #e3e8f7",textAlign:"center",display:"flex",flexDirection:"column",alignItems:"center"},children:[(0,o.jsx)("h2",{style:{fontSize:22,fontWeight:700,color:"#1a237e",marginBottom:18,textAlign:"center"},children:"QR 코드 업로드"}),(0,o.jsx)("div",{style:{marginBottom:18},children:(0,o.jsx)("input",{type:"file",accept:"image/*",onChange:e=>{var t;let n=null===(t=e.target.files)||void 0===t?void 0:t[0];n&&r.Z.scanImage(n,{returnDetailedScanResult:!0}).then(e=>{c(e.data),l("QR 코드가 인식되었습니다. 아래 확인 버튼을 눌러주세요."),console.log("[QR 인식 성공]",e.data)}).catch(e=>{l("QR 이미지 인식 실패"),console.log("[QR 인식 실패]",e)})}})}),(0,o.jsxs)("div",{style:{fontSize:14,color:"#1a237e",marginBottom:24,fontWeight:500},children:["QR 이미지 파일을 업로드하세요.",(0,o.jsx)("br",{}),(0,o.jsx)("span",{style:{color:"#3b5cff",fontWeight:600},children:"(화면 캡처/저장 후 업로드 가능)"})]}),s&&(0,o.jsx)("p",{style:{margin:"24px 0 0 0",fontSize:16,color:"#3b5cff",fontWeight:600},children:s}),d&&(0,o.jsx)("button",{className:"clickable",style:{marginTop:20,padding:"12px 32px",fontSize:17,background:"#1a237e",color:"#fff",border:"none",borderRadius:6,fontWeight:600,boxShadow:"0 1px 4px #e3e8f7"},onClick:u,children:"확인"})]})}},1130:function(e,t,n){"use strict";n.d(t,{ContractProvider:function(){return a},z:function(){return s}});var o=n(7437),i=n(2265);let r=(0,i.createContext)(void 0);function a(e){let{children:t}=e,[n,a]=(0,i.useState)([]),[s,l]=(0,i.useState)(!0),d=(0,i.useCallback)(async()=>{l(!0);try{let e=await fetch("/api/contract",{credentials:"include"});if(!e.ok)throw Error("API error");let t=await e.json();a(t||[])}catch(e){a([])}finally{l(!1)}},[]);return(0,i.useEffect)(()=>{let e=!1;async function t(){e||await d()}t();let n=setInterval(t,1e4);return()=>{e=!0,clearInterval(n)}},[d]),(0,o.jsx)(r.Provider,{value:{contracts:n,loading:s,refreshContracts:d},children:t})}function s(){let e=(0,i.useContext)(r);if(!e)throw Error("useContractContext must be used within a ContractProvider");return e}},9517:function(e,t,n){"use strict";n.d(t,{NotificationProvider:function(){return a},n:function(){return s}});var o=n(7437),i=n(2265);let r=(0,i.createContext)(void 0);function a(e){let{children:t}=e,[n,a]=(0,i.useState)([]),[s,l]=(0,i.useState)(0),[d,c]=(0,i.useState)(!0),u=(0,i.useCallback)(async()=>{c(!0);try{let e=await fetch("/api/auth/notifications",{credentials:"include"});if(!e.ok)throw Error("API error");let t=await e.json();a(t.notifications||[]),l((t.notifications||[]).filter(e=>!e.read).length)}catch(e){a([]),l(0)}finally{c(!1)}},[]);return(0,i.useEffect)(()=>{let e=!1;async function t(){e||await u()}t();let n=setInterval(t,1e4);return()=>{e=!0,clearInterval(n)}},[u]),(0,o.jsx)(r.Provider,{value:{notifications:n,unreadCount:s,loading:d,refreshNotifications:u},children:t})}function s(){let e=(0,i.useContext)(r);if(!e)throw Error("useNotificationContext must be used within a NotificationProvider");return e}},9274:function(e,t,n){"use strict";let o;n.d(t,{LJ:function(){return d},bd:function(){return a},hH:function(){return u},jz:function(){return l},oj:function(){return s},vm:function(){return f}});var i=n(2957).lW,r=n(257);async function a(e,t){let n=new TextEncoder,o=await window.crypto.subtle.importKey("raw",n.encode(e),{name:"PBKDF2"},!1,["deriveKey"]);return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:n.encode(t),iterations:1e5,hash:"SHA-256"},o,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function s(e,t){var n;if(!(null===(n=window.crypto)||void 0===n?void 0:n.subtle))throw Error("이 브라우저는 WebCrypto를 지원하지 않습니다.");let o=new TextEncoder,i=window.crypto.getRandomValues(new Uint8Array(12)),r=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:i},t,o.encode(e));return{iv:btoa(String.fromCharCode(...i)),data:btoa(String.fromCharCode(...new Uint8Array(r)))}}async function l(e,t){var n;if(!(null===(n=window.crypto)||void 0===n?void 0:n.subtle))throw Error("이 브라우저는 WebCrypto를 지원하지 않습니다.");let o=new TextDecoder,i=Uint8Array.from(atob(e.iv),e=>e.charCodeAt(0)),r=Uint8Array.from(atob(e.data),e=>e.charCodeAt(0)),a=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:i},t,r);return o.decode(a)}function d(e){if(!o)throw Error("Node.js crypto not available");let t=i.from(r.env.EMAIL_AES_KEY,"hex"),[n,a]=e.split(":"),s=i.from(n,"hex"),l=o.createDecipheriv("aes-256-cbc",t,s);return l.update(a,"hex","utf8")+l.final("utf8")}async function c(){return a("5012145a3c04312f81ce8b38c90d875f7de96b868f94f451cd6d6709a92d7c23","38f74cb399659a9016a080d65395986f")}async function u(e){let t=await c(),{iv:n,data:o}=await s(e,t);return JSON.stringify({iv:n,data:o})}async function f(e){try{console.log("[decryptLocal] 입력값:",e);let t=await c(),n=JSON.parse(e);console.log("[decryptLocal] 파싱된 iv:",n.iv),console.log("[decryptLocal] 파싱된 data:",n.data);let o=await l({iv:n.iv,data:n.data},t);return console.log("[decryptLocal] 복호화 결과:",o),o}catch(e){throw console.error("[decryptLocal] 복호화 중 에러:",e),e}}},6823:function(e,t,n){"use strict";n.r(t),n.d(t,{STORE_NAME:function(){return r},deleteAESKey:function(){return h},deletePrivateKey:function(){return c},exportPrivateKey:function(){return u},getDB:function(){return s},importPrivateKey:function(){return f},loadAESKey:function(){return p},loadPrivateKey:function(){return d},saveAESKey:function(){return g},savePrivateKey:function(){return l}});var o=n(960),i=n(9274);let r="privateKeys",a="aesKeys";async function s(){return(0,o.X3)("secure-sign-db",1,{upgrade(e){e.objectStoreNames.contains(r)||e.createObjectStore(r),e.objectStoreNames.contains(a)||e.createObjectStore(a)}})}async function l(e,t,n){console.log("[DEBUG] savePrivateKey - 저장 전 privateKey (앞 50):",t.slice(0,50)),console.log("[DEBUG] savePrivateKey - 저장 전 privateKey 길이:",t.length);let o=await (0,i.bd)(n,e),a=await (0,i.oj)(t,o);console.log("[DEBUG] savePrivateKey - 암호화된 privateKey:",JSON.stringify(a).slice(0,100));let l=await s();await l.put(r,a,e)}async function d(e,t){let n=await s(),o=await n.get(r,e);if(!o)return;let a=await (0,i.bd)(t,e),l=await (0,i.jz)(o,a);return console.log("[DEBUG] loadPrivateKey - 복호화된 privateKey (앞 50):",l.slice(0,50)),console.log("[DEBUG] loadPrivateKey - 복호화된 privateKey 길이:",l.length),l}async function c(e){let t=await s();await t.delete(r,e)}async function u(e){let t=await s(),n=await t.get(r,e);if(n)return JSON.stringify({userId:e,encryptedPrivateKey:n})}async function f(e){try{let{userId:t,encryptedPrivateKey:n}=JSON.parse(e);if(!t||!n)throw Error("Invalid backup file");let o=await s();return await o.put(r,n,t),!0}catch(e){return!1}}async function g(e,t,n,o){let i=await s();await i.put(a,{encryptedAESKey:n,iv:o},"".concat(e,":").concat(t))}async function p(e,t){return(await s()).get(a,"".concat(e,":").concat(t))}async function h(e,t){let n=await s();await n.delete(a,"".concat(e,":").concat(t))}},1551:function(){},6829:function(e){e.exports={clickable:"Clickable_clickable__9QdOj"}}},function(e){e.O(0,[63,420,244,855,153,54,971,117,744],function(){return e(e.s=3454)}),_N_E=e.O()}]);