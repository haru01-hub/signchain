(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[595,534],{2678:function(){},5819:function(){},4112:function(){},9680:function(e,t,n){Promise.resolve().then(n.bind(n,9008))},9008:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return d}});var r=n(7437),o=n(2265),a=n(9376),i=n(166),c=n(6181),l=n(8555);let s=(0,i.default)(()=>n.e(174).then(n.bind(n,4174)),{loadableGenerated:{webpack:()=>[4174]},ssr:!1});function d(){let e=(0,a.useParams)(),t=(0,a.useRouter)(),n=e.id,[i,d]=(0,o.useState)(null),[u,f]=(0,o.useState)(""),[p,g]=(0,o.useState)(!0),[h,y]=(0,o.useState)("pending"),[x,v]=(0,o.useState)(null),[m,b]=(0,o.useState)(!1),[w,j]=(0,o.useState)(null);return((0,o.useEffect)(()=>{n&&(g(!0),fetch("/api/contract/".concat(n)).then(e=>{if(!e.ok)throw Error("계약서를 찾을 수 없습니다.");return e.json()}).then(e=>{d(e),v(e.filePath||null),g(!1)}).catch(e=>{f(e.message),g(!1)}))},[n]),(0,o.useEffect)(()=>{(null==i?void 0:i.filePath)&&(y("pending"),j("해시값 생성 중..."),fetch(i.filePath).then(e=>e.arrayBuffer()).then(e=>window.crypto.subtle.digest("SHA-256",e)).then(e=>{Array.from(new Uint8Array(e)).map(e=>e.toString(16).padStart(2,"0")).join("")===i.hash?(y("valid"),j("✅ 해시값 검증 완료!")):(y("invalid"),j("❌ 무결성 오류: 파일이 변조되었을 수 있습니다!")),setTimeout(()=>j(null),2e3)}).catch(()=>{y("invalid"),j("❌ 무결성 오류: 파일이 변조되었을 수 있습니다!"),setTimeout(()=>j(null),2e3)}))},[i]),p)?(0,r.jsx)("div",{style:{padding:40},children:"불러오는 중..."}):u?(0,r.jsx)("div",{style:{color:"red",padding:40},children:u}):i?(0,r.jsxs)("div",{style:{maxWidth:600,margin:"40px auto",padding:24,border:"1px solid #eee",borderRadius:10,background:"#fafbfc"},children:[(0,r.jsx)("h2",{style:{fontSize:22,marginBottom:18},children:"계약 상세"}),(0,r.jsxs)("div",{style:{marginBottom:16},children:[(0,r.jsx)("strong",{children:"제목:"})," ",i.title]}),(0,r.jsxs)("div",{style:{marginBottom:16},children:[(0,r.jsx)("strong",{children:"작성일:"})," ",new Date(i.createdAt).toLocaleString()]}),(0,r.jsxs)("div",{style:{marginBottom:16},children:[(0,r.jsx)("strong",{children:"상태:"})," ",i.signed?(0,r.jsx)("span",{style:{color:"green"},children:"서명 완료"}):(0,r.jsx)("span",{style:{color:"red"},children:"서명 미완료"})]}),(0,r.jsxs)("div",{style:{marginBottom:16},children:[(0,r.jsx)("strong",{children:"작성자:"})," ",i.creator||"-"]}),(0,r.jsxs)("div",{style:{marginBottom:16},children:[(0,r.jsx)("strong",{children:"서명자:"})," ",i.signer||"-"]}),(0,r.jsxs)("div",{style:{marginBottom:16},children:[(0,r.jsx)("strong",{children:"내용:"}),(0,r.jsx)("div",{style:{background:"#fff",border:"1px solid #eee",borderRadius:6,padding:12,marginTop:6},children:i.content||(0,r.jsx)("span",{style:{color:"#aaa"},children:"-"})})]}),(0,r.jsxs)("div",{style:{marginBottom:16},children:[(0,r.jsx)("strong",{children:"해시:"})," ",(0,r.jsx)("span",{style:{fontSize:13,color:"#888"},children:i.hash})]}),(0,r.jsxs)("div",{style:{marginBottom:16},children:[(0,r.jsx)("strong",{children:"파일:"})," ",x?(0,r.jsx)("a",{href:x,target:"_blank",rel:"noopener noreferrer",children:"다운로드"}):"-"]}),(0,r.jsxs)("div",{style:{marginBottom:16},children:[(0,r.jsx)("strong",{children:"무결성 검증:"})," ","pending"===h?(0,r.jsx)("span",{style:{color:"#888"},children:"검증 중..."}):"valid"===h?(0,r.jsx)("span",{style:{color:"green"},children:"✅ 무결성 이상 없음"}):(0,r.jsx)("span",{style:{color:"red"},children:"❌ 무결성 오류: 파일이 변조되었을 수 있습니다!"})]}),!m&&(0,r.jsx)("div",{style:{marginBottom:24},children:(0,r.jsx)(l.Z,{contractId:i._id,onSuccess:()=>{b(!0),j("QR 인증 성공! 이제 서명할 수 있습니다."),setTimeout(()=>j(null),2e3)}})}),(0,r.jsx)(c.Z,{contractId:i._id,contractHash:i.hash,canSign:m,onSigned:()=>{j("서명이 성공적으로 완료되었습니다!"),setTimeout(()=>j(null),2e3)}}),(0,r.jsx)(s,{contractId:i._id}),(0,r.jsx)("div",{style:{display:"flex",gap:12,marginTop:32},children:(0,r.jsx)("button",{onClick:()=>t.push("/contract"),style:{background:"#1976d2",color:"#fff",border:"none",borderRadius:6,padding:"8px 18px",fontWeight:500,cursor:"pointer"},children:"목록으로"})}),w&&(0,r.jsx)("div",{style:{position:"fixed",top:80,left:"50%",transform:"translateX(-50%)",background:"#222",color:"#fff",padding:"12px 32px",borderRadius:8,fontSize:16,zIndex:9999,boxShadow:"0 2px 8px #0003"},children:w})]}):(0,r.jsx)("div",{style:{padding:40},children:"계약 정보를 불러올 수 없습니다."})}},6181:function(e,t,n){"use strict";var r=n(7437),o=n(2265),a=n(8677),i=n(6823),c=n(3855),l=n.n(c),s=n(9274);t.Z=e=>{let{contractId:t,contractHash:n,onSigned:c,canSign:d=!0}=e,u=(0,o.useRef)(null),[f,p]=(0,o.useState)(""),[g,h]=(0,o.useState)(""),[y,x]=(0,o.useState)(""),v=async()=>{let e=await fetch("/api/contract/".concat(t)),r=await e.json();if(new Date(r.expirationDate)<new Date){console.log("계약서 만료:",r.expirationDate),h("계약서가 만료되었습니다. 서명할 수 없습니다.");return}if(!f){h("서명자 이름을 입력하세요.");return}if(!y){h("손글씨 서명을 입력하세요.");return}let o=localStorage.getItem("userId")||"",a=o?await (0,s.vm)(o):"",d=prompt("비밀번호를 입력하세요")||"",g=await (0,i.loadPrivateKey)(a,d);if(console.log("서명에 사용할 개인키:",g),!g){h("개인키를 찾을 수 없습니다.");return}let v=l().pki.privateKeyFromPem(g),m=l().md.sha256.create();m.update(n,"utf8");let b=l().util.encode64(v.sign(m)),w=l().md.sha256.create();w.update(y,"utf8");let j=l().util.encode64(v.sign(w));if(console.log("계약서 해시값:",n),console.log("손글씨 해시값:",y),console.log("계약서 해시 서명:",b),console.log("손글씨 해시 서명:",j),(await fetch("/api/contract/".concat(t),{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({fileSignature:b,signImageSignature:j,contractHash:n,signImageHash:y,signer:f})})).ok){var S;h("서명 성공!"),console.log("서명 성공! uploaded → signed 상태 변경"),null===(S=u.current)||void 0===S||S.clear(),p(""),x(""),c&&c()}else h("서명 실패")};return(0,r.jsxs)("div",{style:{margin:"32px 0",padding:32,background:"#f8fafd",borderRadius:16,boxShadow:"0 2px 8px #0001",minWidth:480},children:[(0,r.jsx)("h3",{style:{marginBottom:20,fontSize:26},children:"✍️ 계약서 서명"}),(0,r.jsx)("input",{type:"text",placeholder:"서명자 이름",value:f,onChange:e=>p(e.target.value),style:{padding:"12px",width:"100%",marginBottom:"16px",fontSize:18}}),(0,r.jsx)(a.Z,{penColor:"black",canvasProps:{width:1e3,height:400,className:"sigCanvas"},ref:u,backgroundColor:"#f0f0f0",onEnd:()=>{var e;let t=null===(e=u.current)||void 0===e?void 0:e.toDataURL();t&&x(t)}}),(0,r.jsxs)("div",{style:{marginTop:"16px",display:"flex",gap:"16px",justifyContent:"center"},children:[(0,r.jsx)("button",{onClick:()=>{var e;null===(e=u.current)||void 0===e||e.clear(),x("")},style:{padding:"12px 24px",backgroundColor:"#757575",color:"#fff",border:"none",borderRadius:"8px",cursor:"pointer",fontSize:18},children:"지우기"}),(0,r.jsx)("button",{onClick:v,style:{padding:"12px 24px",backgroundColor:"#8bc34a",color:"#fff",border:"none",borderRadius:"8px",cursor:d?"pointer":"not-allowed",fontSize:18},disabled:!d,children:"서명 제출"})]}),g&&(0,r.jsx)("p",{style:{marginTop:"16px",fontSize:18},children:g})]})}},8555:function(e,t,n){"use strict";var r=n(7437),o=n(2265),a=n(6324),i=n(3464);t.Z=e=>{let{contractId:t,onSuccess:n}=e,[c,l]=(0,o.useState)(""),[s,d]=(0,o.useState)(null),u=async()=>{if(!s||!s.trim()){l("QR 코드가 인식되지 않았습니다. 이미지를 다시 업로드해 주세요."),console.log("[QR 확인 실패] 스캔 데이터 없음");return}try{console.log("[QR 확인 요청] contractId:",t,"qrCode:",s.trim());let e=await i.Z.post("/api/Qr/verify-qr",{contractId:t,qrCode:s.trim()});console.log("[QR 확인 응답]",e.data),e.data.success?(l("인증 성공! 서명 단계로 이동합니다..."),n&&n(s)):(l(e.data.message||"QR 코드 인증 실패: 올바른 QR 코드가 아닙니다."),console.log("[QR 인증 실패]",e.data))}catch(t){var e,r;l((null==t?void 0:null===(r=t.response)||void 0===r?void 0:null===(e=r.data)||void 0===e?void 0:e.message)||"QR 코드 인증 실패: 서버 오류"),console.log("[QR 인증 예외]",t)}};return(0,r.jsxs)("div",{style:{minWidth:320,maxWidth:400,margin:"0 auto",padding:32,background:"#fff",borderRadius:16,boxShadow:"0 2px 16px #e3e8f7",border:"1px solid #e3e8f7",textAlign:"center",display:"flex",flexDirection:"column",alignItems:"center"},children:[(0,r.jsx)("h2",{style:{fontSize:22,fontWeight:700,color:"#1a237e",marginBottom:18,textAlign:"center"},children:"QR 코드 업로드"}),(0,r.jsx)("div",{style:{marginBottom:18},children:(0,r.jsx)("input",{type:"file",accept:"image/*",onChange:e=>{var t;let n=null===(t=e.target.files)||void 0===t?void 0:t[0];n&&a.Z.scanImage(n,{returnDetailedScanResult:!0}).then(e=>{d(e.data),l("QR 코드가 인식되었습니다. 아래 확인 버튼을 눌러주세요."),console.log("[QR 인식 성공]",e.data)}).catch(e=>{l("QR 이미지 인식 실패"),console.log("[QR 인식 실패]",e)})}})}),(0,r.jsxs)("div",{style:{fontSize:14,color:"#1a237e",marginBottom:24,fontWeight:500},children:["QR 이미지 파일을 업로드하세요.",(0,r.jsx)("br",{}),(0,r.jsx)("span",{style:{color:"#3b5cff",fontWeight:600},children:"(화면 캡처/저장 후 업로드 가능)"})]}),c&&(0,r.jsx)("p",{style:{margin:"24px 0 0 0",fontSize:16,color:"#3b5cff",fontWeight:600},children:c}),s&&(0,r.jsx)("button",{className:"clickable",style:{marginTop:20,padding:"12px 32px",fontSize:17,background:"#1a237e",color:"#fff",border:"none",borderRadius:6,fontWeight:600,boxShadow:"0 1px 4px #e3e8f7"},onClick:u,children:"확인"})]})}},9274:function(e,t,n){"use strict";let r;n.d(t,{LJ:function(){return s},bd:function(){return i},hH:function(){return u},jz:function(){return l},oj:function(){return c},vm:function(){return f}});var o=n(2957).lW,a=n(257);async function i(e,t){let n=new TextEncoder,r=await window.crypto.subtle.importKey("raw",n.encode(e),{name:"PBKDF2"},!1,["deriveKey"]);return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:n.encode(t),iterations:1e5,hash:"SHA-256"},r,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function c(e,t){var n;if(!(null===(n=window.crypto)||void 0===n?void 0:n.subtle))throw Error("이 브라우저는 WebCrypto를 지원하지 않습니다.");let r=new TextEncoder,o=window.crypto.getRandomValues(new Uint8Array(12)),a=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:o},t,r.encode(e));return{iv:btoa(String.fromCharCode(...o)),data:btoa(String.fromCharCode(...new Uint8Array(a)))}}async function l(e,t){var n;if(!(null===(n=window.crypto)||void 0===n?void 0:n.subtle))throw Error("이 브라우저는 WebCrypto를 지원하지 않습니다.");let r=new TextDecoder,o=Uint8Array.from(atob(e.iv),e=>e.charCodeAt(0)),a=Uint8Array.from(atob(e.data),e=>e.charCodeAt(0)),i=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:o},t,a);return r.decode(i)}function s(e){if(!r)throw Error("Node.js crypto not available");let t=o.from(a.env.EMAIL_AES_KEY,"hex"),[n,i]=e.split(":"),c=o.from(n,"hex"),l=r.createDecipheriv("aes-256-cbc",t,c);return l.update(i,"hex","utf8")+l.final("utf8")}async function d(){return i("5012145a3c04312f81ce8b38c90d875f7de96b868f94f451cd6d6709a92d7c23","38f74cb399659a9016a080d65395986f")}async function u(e){let t=await d(),{iv:n,data:r}=await c(e,t);return JSON.stringify({iv:n,data:r})}async function f(e){try{console.log("[decryptLocal] 입력값:",e);let t=await d(),n=JSON.parse(e);console.log("[decryptLocal] 파싱된 iv:",n.iv),console.log("[decryptLocal] 파싱된 data:",n.data);let r=await l({iv:n.iv,data:n.data},t);return console.log("[decryptLocal] 복호화 결과:",r),r}catch(e){throw console.error("[decryptLocal] 복호화 중 에러:",e),e}}},6823:function(e,t,n){"use strict";n.r(t),n.d(t,{STORE_NAME:function(){return a},deleteAESKey:function(){return h},deletePrivateKey:function(){return d},exportPrivateKey:function(){return u},getDB:function(){return c},importPrivateKey:function(){return f},loadAESKey:function(){return g},loadPrivateKey:function(){return s},saveAESKey:function(){return p},savePrivateKey:function(){return l}});var r=n(960),o=n(9274);let a="privateKeys",i="aesKeys";async function c(){return(0,r.X3)("secure-sign-db",1,{upgrade(e){e.objectStoreNames.contains(a)||e.createObjectStore(a),e.objectStoreNames.contains(i)||e.createObjectStore(i)}})}async function l(e,t,n){console.log("[DEBUG] savePrivateKey - 저장 전 privateKey (앞 50):",t.slice(0,50)),console.log("[DEBUG] savePrivateKey - 저장 전 privateKey 길이:",t.length);let r=await (0,o.bd)(n,e),i=await (0,o.oj)(t,r);console.log("[DEBUG] savePrivateKey - 암호화된 privateKey:",JSON.stringify(i).slice(0,100));let l=await c();await l.put(a,i,e)}async function s(e,t){let n=await c(),r=await n.get(a,e);if(!r)return;let i=await (0,o.bd)(t,e),l=await (0,o.jz)(r,i);return console.log("[DEBUG] loadPrivateKey - 복호화된 privateKey (앞 50):",l.slice(0,50)),console.log("[DEBUG] loadPrivateKey - 복호화된 privateKey 길이:",l.length),l}async function d(e){let t=await c();await t.delete(a,e)}async function u(e){let t=await c(),n=await t.get(a,e);if(n)return JSON.stringify({userId:e,encryptedPrivateKey:n})}async function f(e){try{let{userId:t,encryptedPrivateKey:n}=JSON.parse(e);if(!t||!n)throw Error("Invalid backup file");let r=await c();return await r.put(a,n,t),!0}catch(e){return!1}}async function p(e,t,n,r){let o=await c();await o.put(i,{encryptedAESKey:n,iv:r},"".concat(e,":").concat(t))}async function g(e,t){return(await c()).get(i,"".concat(e,":").concat(t))}async function h(e,t){let n=await c();await n.delete(i,"".concat(e,":").concat(t))}}},function(e){e.O(0,[244,855,153,971,117,744],function(){return e(e.s=9680)}),_N_E=e.O()}]);