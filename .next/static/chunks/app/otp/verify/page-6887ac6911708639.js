(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[210],{417:function(e,t,r){Promise.resolve().then(r.bind(r,6591))},6591:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return y},dynamic:function(){return l}});var n=r(7437),a=r(2265),o=r(9376),i=r(6823),s=r(3519),c=r(9274);async function u(e,t){let r=await fetch(e,{...t,credentials:"include"});if(401===r.status){if((await fetch("/api/auth/refresh",{method:"POST",credentials:"include"})).ok)r=await fetch(e,{...t,credentials:"include"});else throw Error("세션이 만료되었습니다. 다시 로그인 해주세요.")}return r}let l="force-dynamic";function d(e){return/^\d{6}$/.test(e)}function f(){let[e,t]=(0,a.useState)(""),[l,f]=(0,a.useState)(""),[y,p]=(0,a.useState)({}),[h,v]=(0,a.useState)(""),[w,m]=(0,a.useState)(!1),g=(0,o.useSearchParams)().get("mode"),b=(0,a.useRef)(null),E=(0,o.useRouter)(),S="register"===g,P=d(e)&&(!S||l.length>=6);async function j(t){if(t&&t.preventDefault(),!P){v("입력값을 다시 확인하세요.");return}v(""),m(!0);try{let t;let n=await u("/api/otp/verify",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({token:e}),credentials:"include"});console.log("RAW response:",n);try{let e=n.headers.get("content-type");t=e&&e.includes("application/json")?await n.json():{message:await n.text()},console.log("Parsed data:",t)}catch(e){console.error("응답 파싱 실패:",e,n),v("응답 파싱 실패: "+e),m(!1);return}if(t.redirectTo){if(S)try{if(!t.userId)throw Error("userId 없음");if(!t.privateKey)throw Error("서버에서 개인키를 받지 못했습니다.");if(await (0,i.savePrivateKey)(t.userId,t.privateKey,l),localStorage.setItem("userId",await (0,c.hH)(t.userId)),t.email&&localStorage.setItem("email",await (0,c.hH)(t.email)),t.publicKey)try{let e=(await Promise.all([r.e(855),r.e(534)]).then(r.t.bind(r,3855,23))).default,n=e.pki.privateKeyFromPem(t.privateKey),a=e.pki.setRsaPublicKey(n.n,n.e);e.pki.publicKeyToPem(a),t.publicKey,E.push(t.redirectTo);return}catch(e){console.error("[DEBUG] 공개키 비교 중 오류:",e),m(!1);return}m(!1);return}catch(e){v("개인키 저장 오류: "+(e instanceof Error?e.message:String(e))),m(!1);return}E.push(t.redirectTo);return}v(t.message||"OTP 인증 실패"),m(!1)}catch(e){v("인증 중 오류가 발생했습니다."),m(!1)}}return(0,a.useEffect)(()=>{b.current&&b.current.focus()},[]),(0,n.jsxs)("div",{className:"card",children:[w&&(0,n.jsx)(s.Z,{}),(0,n.jsx)("h1",{children:"OTP 인증"}),(0,n.jsxs)("p",{style:{marginBottom:S?0:10},children:["\uD83D\uDCF1 Google Authenticator 등에서 OTP 코드를 입력하세요."," ",S&&(0,n.jsxs)("span",{style:{color:"#1a237e",fontSize:15,fontWeight:500},children:[(0,n.jsx)("b",{children:"아래 비밀번호는 전자서명 및 파일 복호화, 개인키 복구 등에 사용됩니다."}),(0,n.jsx)("br",{}),(0,n.jsx)("span",{style:{color:"#d32f2f",fontWeight:500},children:"로그인/회원가입 비밀번호와 다를 수 있으니 반드시 기억해 주세요."})]})]}),(0,n.jsxs)("form",{onSubmit:j,autoComplete:"off",children:[(0,n.jsx)("input",{ref:b,value:e,onChange:e=>{t(e.target.value),p(e=>({...e,otp:!0})),v("")},placeholder:"OTP 코드 입력 (6자리 숫자)",style:{marginTop:10,borderColor:y.otp&&!d(e)?"red":void 0}}),y.otp&&!d(e)&&(0,n.jsx)("div",{style:{color:"red",fontSize:13},children:"6자리 숫자를 입력하세요."}),S&&(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)("div",{style:{height:12}}),(0,n.jsx)("input",{type:"password",value:l,onChange:e=>{f(e.target.value),p(e=>({...e,pw:!0})),v("")},placeholder:"전자서명용 비밀번호 (6자리 이상)",style:{marginTop:0,borderColor:y.pw&&l.length<6?"red":void 0}}),y.pw&&l.length<6&&(0,n.jsx)("div",{style:{color:"red",fontSize:13},children:"6자리 이상 비밀번호를 입력하세요."})]}),(0,n.jsx)("button",{type:"submit",disabled:!P,style:{width:"100%",marginTop:12},children:"OTP 인증"})]}),h&&(0,n.jsx)("div",{style:{color:"red",marginTop:10},children:h}),"login"===g&&(0,n.jsx)(n.Fragment,{})]})}function y(){return(0,n.jsx)(a.Suspense,{children:(0,n.jsx)(f,{})})}},3519:function(e,t,r){"use strict";var n=r(7437);r(2265),r(1551),t.Z=()=>(0,n.jsx)("div",{className:"spinner-overlay",children:(0,n.jsx)("div",{className:"spinner"})})},9376:function(e,t,r){"use strict";var n=r(5475);r.o(n,"useParams")&&r.d(t,{useParams:function(){return n.useParams}}),r.o(n,"usePathname")&&r.d(t,{usePathname:function(){return n.usePathname}}),r.o(n,"useRouter")&&r.d(t,{useRouter:function(){return n.useRouter}}),r.o(n,"useSearchParams")&&r.d(t,{useSearchParams:function(){return n.useSearchParams}})},9274:function(e,t,r){"use strict";let n;r.d(t,{LJ:function(){return u},bd:function(){return i},hH:function(){return d},jz:function(){return c},oj:function(){return s},vm:function(){return f}});var a=r(2957).lW,o=r(257);async function i(e,t){let r=new TextEncoder,n=await window.crypto.subtle.importKey("raw",r.encode(e),{name:"PBKDF2"},!1,["deriveKey"]);return window.crypto.subtle.deriveKey({name:"PBKDF2",salt:r.encode(t),iterations:1e5,hash:"SHA-256"},n,{name:"AES-GCM",length:256},!1,["encrypt","decrypt"])}async function s(e,t){var r;if(!(null===(r=window.crypto)||void 0===r?void 0:r.subtle))throw Error("이 브라우저는 WebCrypto를 지원하지 않습니다.");let n=new TextEncoder,a=window.crypto.getRandomValues(new Uint8Array(12)),o=await window.crypto.subtle.encrypt({name:"AES-GCM",iv:a},t,n.encode(e));return{iv:btoa(String.fromCharCode(...a)),data:btoa(String.fromCharCode(...new Uint8Array(o)))}}async function c(e,t){var r;if(!(null===(r=window.crypto)||void 0===r?void 0:r.subtle))throw Error("이 브라우저는 WebCrypto를 지원하지 않습니다.");let n=new TextDecoder,a=Uint8Array.from(atob(e.iv),e=>e.charCodeAt(0)),o=Uint8Array.from(atob(e.data),e=>e.charCodeAt(0)),i=await window.crypto.subtle.decrypt({name:"AES-GCM",iv:a},t,o);return n.decode(i)}function u(e){if(!n)throw Error("Node.js crypto not available");let t=a.from(o.env.EMAIL_AES_KEY,"hex"),[r,i]=e.split(":"),s=a.from(r,"hex"),c=n.createDecipheriv("aes-256-cbc",t,s);return c.update(i,"hex","utf8")+c.final("utf8")}async function l(){return i("5012145a3c04312f81ce8b38c90d875f7de96b868f94f451cd6d6709a92d7c23","38f74cb399659a9016a080d65395986f")}async function d(e){let t=await l(),{iv:r,data:n}=await s(e,t);return JSON.stringify({iv:r,data:n})}async function f(e){try{console.log("[decryptLocal] 입력값:",e);let t=await l(),r=JSON.parse(e);console.log("[decryptLocal] 파싱된 iv:",r.iv),console.log("[decryptLocal] 파싱된 data:",r.data);let n=await c({iv:r.iv,data:r.data},t);return console.log("[decryptLocal] 복호화 결과:",n),n}catch(e){throw console.error("[decryptLocal] 복호화 중 에러:",e),e}}},6823:function(e,t,r){"use strict";r.r(t),r.d(t,{STORE_NAME:function(){return o},deleteAESKey:function(){return h},deletePrivateKey:function(){return l},exportPrivateKey:function(){return d},getDB:function(){return s},importPrivateKey:function(){return f},loadAESKey:function(){return p},loadPrivateKey:function(){return u},saveAESKey:function(){return y},savePrivateKey:function(){return c}});var n=r(960),a=r(9274);let o="privateKeys",i="aesKeys";async function s(){return(0,n.X3)("secure-sign-db",1,{upgrade(e){e.objectStoreNames.contains(o)||e.createObjectStore(o),e.objectStoreNames.contains(i)||e.createObjectStore(i)}})}async function c(e,t,r){console.log("[DEBUG] savePrivateKey - 저장 전 privateKey (앞 50):",t.slice(0,50)),console.log("[DEBUG] savePrivateKey - 저장 전 privateKey 길이:",t.length);let n=await (0,a.bd)(r,e),i=await (0,a.oj)(t,n);console.log("[DEBUG] savePrivateKey - 암호화된 privateKey:",JSON.stringify(i).slice(0,100));let c=await s();await c.put(o,i,e)}async function u(e,t){let r=await s(),n=await r.get(o,e);if(!n)return;let i=await (0,a.bd)(t,e),c=await (0,a.jz)(n,i);return console.log("[DEBUG] loadPrivateKey - 복호화된 privateKey (앞 50):",c.slice(0,50)),console.log("[DEBUG] loadPrivateKey - 복호화된 privateKey 길이:",c.length),c}async function l(e){let t=await s();await t.delete(o,e)}async function d(e){let t=await s(),r=await t.get(o,e);if(r)return JSON.stringify({userId:e,encryptedPrivateKey:r})}async function f(e){try{let{userId:t,encryptedPrivateKey:r}=JSON.parse(e);if(!t||!r)throw Error("Invalid backup file");let n=await s();return await n.put(o,r,t),!0}catch(e){return!1}}async function y(e,t,r,n){let a=await s();await a.put(i,{encryptedAESKey:r,iv:n},"".concat(e,":").concat(t))}async function p(e,t){return(await s()).get(i,"".concat(e,":").concat(t))}async function h(e,t){let r=await s();await r.delete(i,"".concat(e,":").concat(t))}},1551:function(){},960:function(e,t,r){"use strict";let n,a,o,i;r.d(t,{X3:function(){return p}});let s=(e,t)=>t.some(t=>e instanceof t),c=new WeakMap,u=new WeakMap,l=new WeakMap,d={get(e,t,r){if(e instanceof IDBTransaction){if("done"===t)return c.get(e);if("store"===t)return r.objectStoreNames[1]?void 0:r.objectStore(r.objectStoreNames[0])}return f(e[t])},set:(e,t,r)=>(e[t]=r,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function f(e){var t;if(e instanceof IDBRequest)return function(e){let t=new Promise((t,r)=>{let n=()=>{e.removeEventListener("success",a),e.removeEventListener("error",o)},a=()=>{t(f(e.result)),n()},o=()=>{r(e.error),n()};e.addEventListener("success",a),e.addEventListener("error",o)});return l.set(t,e),t}(e);if(u.has(e))return u.get(e);let r="function"==typeof(t=e)?(a||(a=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(t)?function(...e){return t.apply(y(this),e),f(this.request)}:function(...e){return f(t.apply(y(this),e))}:(t instanceof IDBTransaction&&function(e){if(c.has(e))return;let t=new Promise((t,r)=>{let n=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",o),e.removeEventListener("abort",o)},a=()=>{t(),n()},o=()=>{r(e.error||new DOMException("AbortError","AbortError")),n()};e.addEventListener("complete",a),e.addEventListener("error",o),e.addEventListener("abort",o)});c.set(e,t)}(t),s(t,n||(n=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])))?new Proxy(t,d):t;return r!==e&&(u.set(e,r),l.set(r,e)),r}let y=e=>l.get(e);function p(e,t,{blocked:r,upgrade:n,blocking:a,terminated:o}={}){let i=indexedDB.open(e,t),s=f(i);return n&&i.addEventListener("upgradeneeded",e=>{n(f(i.result),e.oldVersion,e.newVersion,f(i.transaction),e)}),r&&i.addEventListener("blocked",e=>r(e.oldVersion,e.newVersion,e)),s.then(e=>{o&&e.addEventListener("close",()=>o()),a&&e.addEventListener("versionchange",e=>a(e.oldVersion,e.newVersion,e))}).catch(()=>{}),s}let h=["get","getKey","getAll","getAllKeys","count"],v=["put","add","delete","clear"],w=new Map;function m(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&"string"==typeof t))return;if(w.get(t))return w.get(t);let r=t.replace(/FromIndex$/,""),n=t!==r,a=v.includes(r);if(!(r in(n?IDBIndex:IDBObjectStore).prototype)||!(a||h.includes(r)))return;let o=async function(e,...t){let o=this.transaction(e,a?"readwrite":"readonly"),i=o.store;return n&&(i=i.index(t.shift())),(await Promise.all([i[r](...t),a&&o.done]))[0]};return w.set(t,o),o}d={...o=d,get:(e,t,r)=>m(e,t)||o.get(e,t,r),has:(e,t)=>!!m(e,t)||o.has(e,t)};let g=["continue","continuePrimaryKey","advance"],b={},E=new WeakMap,S=new WeakMap,P={get(e,t){if(!g.includes(t))return e[t];let r=b[t];return r||(r=b[t]=function(...e){E.set(this,S.get(this)[t](...e))}),r}};async function*j(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;let r=new Proxy(t,P);for(S.set(r,t),l.set(r,y(t));t;)yield r,t=await (E.get(r)||t.continue()),E.delete(r)}function x(e,t){return t===Symbol.asyncIterator&&s(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&s(e,[IDBIndex,IDBObjectStore])}d={...i=d,get:(e,t,r)=>x(e,t)?j:i.get(e,t,r),has:(e,t)=>x(e,t)||i.has(e,t)}}},function(e){e.O(0,[63,244,971,117,744],function(){return e(e.s=417)}),_N_E=e.O()}]);