"use strict";(()=>{var e={};e.id=3600,e.ids=[3600],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},61772:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>P,patchFetch:()=>C,requestAsyncStorage:()=>b,routeModule:()=>T,serverHooks:()=>R,staticGenerationAsyncStorage:()=>A});var i={};r.r(i),r.d(i,{OPTIONS:()=>x,POST:()=>E});var s=r(49303),o=r(88716),a=r(60670),n=r(87070),p=r(10429),u=r(45256),l=r(71732),c=r(41482),d=r.n(c),m=r(32646),f=r(37060),y=r.n(f),g=r(58543);let S=process.env.CA_PRIVATE_KEY,v=process.env.CA_CERT;if(!S)throw Error("CA 개인키가 환경변수에 없습니다.");if(!v)throw Error("CA 인증서가 환경변수에 없습니다.");let h=y().pki.privateKeyFromPem(S),w=y().pki.certificateFromPem(v);function x(){return n.NextResponse.json({},{status:200,headers:{"Access-Control-Allow-Origin":"http://localhost:3000","Access-Control-Allow-Credentials":"true","Access-Control-Allow-Methods":"POST,OPTIONS","Access-Control-Allow-Headers":"Content-Type"}})}async function E(e){try{let i;await (0,u.X)();let s=e.cookies.get("token")?.value;if(!s)return n.NextResponse.json({message:"Unauthorized"},{status:401});if(!process.env.JWT_SECRET)return n.NextResponse.json({message:"서버 설정 오류: JWT_SECRET이 정의되지 않았습니다."},{status:500});try{i=d().verify(s,process.env.JWT_SECRET)}catch(e){return n.NextResponse.json({message:"유효하지 않은 토큰입니다."},{status:403})}let o=i?.id||i?.userId;if(!o)return n.NextResponse.json({message:"Unauthorized"},{status:401});let{token:a}=await e.json(),c=null,f=null;if(/^[0-9a-fA-F]{24}$/.test(o)?f=await l.Z.findById(o):c=await m.Z.findOne({email:o}),c){let e=(0,g.LJ)(c.otpSecret);if(!p.totp.verify({secret:e,encoding:"base32",token:a,window:2}))return n.NextResponse.json({message:"OTP 인증 실패"},{status:400});{var t;let{publicKey:e,privateKey:i}=function(){let e=y().pki.rsa.generateKeyPair(2048),t=y().pki.publicKeyToPem(e.publicKey),r=y().pki.privateKeyToPem(e.privateKey);try{let t=y().pki.rsa.setPublicKey(e.privateKey.n,e.privateKey.e);y().pki.publicKeyToPem(t)}catch(e){}return{publicKey:t,privateKey:r}}(),s=function(e,t){let r=y().pki.createCertificate();return r.publicKey=y().pki.publicKeyFromPem(e),r.serialNumber=Math.floor(1e16*Math.random()).toString(),r.validity.notBefore=new Date,r.validity.notAfter=new Date,r.validity.notAfter.setFullYear(r.validity.notBefore.getFullYear()+1),r.setSubject([{name:"commonName",value:t}]),r.setIssuer(w.subject.attributes),r.sign(h),y().pki.certificateToPem(r)}(e,c.email),o=c.otpSecret;o.includes(":")||(o=(0,g.UN)(o));let a=await l.Z.create({email:c.email,username:c.username,password:c.password,otpSecret:o,otpEnabled:!0,otpVerified:!0,certificateStatus:"valid",publicKey:e,certificate:s});await m.Z.deleteOne({email:c.email});let p=r(36454).Z;await p.create({recipientEmail:(t=(0,g.LJ)(a.email).trim().toLowerCase(),"string"==typeof t&&t.includes(":")?t:(0,g.UN)(t)),message:`회원가입: ${new Date().toLocaleString("ko-KR",{hour12:!1})}`,timestamp:new Date,read:!1,type:"system"});let u=d().sign({id:a._id,email:(0,g.LJ)(a.email).trim().toLowerCase(),username:a.username,otpVerified:a.otpVerified,certificateStatus:a.certificateStatus},process.env.JWT_SECRET,{expiresIn:"1h"}),f=n.NextResponse.json({message:"OTP 인증 성공",certificate:s,privateKey:i,publicKey:e,userId:a._id,redirectTo:"/contract"});return f.cookies.set("token",u,{httpOnly:!0,path:"/",maxAge:3600,secure:!0,sameSite:"strict"}),f}}if(!f)return n.NextResponse.json({message:"임시 회원 정보 또는 사용자 정보가 없습니다."},{status:404});{if(!f.otpSecret)return n.NextResponse.json({message:"OTP 시크릿이 없습니다."},{status:400});let e=(0,g.LJ)(f.otpSecret);if(!p.totp.verify({secret:e,encoding:"base32",token:a,window:2}))return n.NextResponse.json({message:"OTP 인증 실패"},{status:400});{f.otpVerified=!0,f.otpEnabled=!0,await f.save();let e=d().sign({id:f._id,email:(f.email.includes(":")?(0,g.LJ)(f.email):f.email).trim().toLowerCase(),username:f.username,otpVerified:f.otpVerified,certificateStatus:f.certificateStatus},process.env.JWT_SECRET,{expiresIn:"1h"}),t=n.NextResponse.json({message:"OTP 인증 성공",userId:f._id,redirectTo:"/contract"});return t.cookies.set("token",e,{httpOnly:!0,path:"/",maxAge:3600,secure:!0,sameSite:"strict"}),t}}}catch(e){return n.NextResponse.json({message:"서버 오류가 발생했습니다."},{status:500})}}let T=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/otp/verify/route",pathname:"/api/otp/verify",filename:"route",bundlePath:"app/api/otp/verify/route"},resolvedPagePath:"E:\\test2\\app\\api\\otp\\verify\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:b,staticGenerationAsyncStorage:A,serverHooks:R}=T,P="/api/otp/verify/route";function C(){return(0,a.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:A})}},45256:(e,t,r)=>{let i;r.d(t,{X:()=>n});var s=r(11185),o=r.n(s);let a=process.env.MONGODB_URI;if(!a)throw Error("MongoDB URI가 .env에 설정되어 있지 않습니다.");async function n(){i.conn&&i.conn.readyState>=1||(i.promise||(i.promise=o().connect(a).then(e=>e.connection)),i.conn=await i.promise)}global.mongoose?i=global.mongoose:(i={conn:null,promise:null},global.mongoose=i)},36454:(e,t,r)=>{r.d(t,{Z:()=>a});var i=r(11185),s=r.n(i);let o=new i.Schema({recipientEmail:{type:String,required:!0},message:{type:String,required:!0},timestamp:{type:Date,default:Date.now},read:{type:Boolean,default:!1},type:{type:String,enum:["system","message"],default:"system"},contractId:{type:i.Schema.Types.ObjectId,ref:"Contract"},senderEmail:{type:String}}),a=s().models.Notification||s().model("Notification",o)},32646:(e,t,r)=>{r.d(t,{Z:()=>a});var i=r(11185),s=r.n(i);let o=new(s()).Schema({email:{type:String,required:!0},username:{type:String,required:!0},password:{type:String,required:!0},otpSecret:{type:String,required:!0},createdAt:{type:Date,default:Date.now,expires:300}}),a=s().models.TempUser||s().model("TempUser",o)},71732:(e,t,r)=>{r.d(t,{Z:()=>a});var i=r(11185),s=r.n(i);let o=new i.Schema({username:{type:String,required:!0,unique:!0},email:{type:String,required:!0,unique:!0},password:{type:String,required:!0},publicKey:{type:String},certificate:{type:String},otpEnabled:{type:Boolean,default:!1},otpSecret:{type:String},otpVerified:{type:Boolean,default:!1},certificateStatus:{type:String,default:"valid"},currentRefreshJti:{type:String}}),a=s().models.User||s().model("User",o)},58543:(e,t,r)=>{let i;r.d(t,{LJ:()=>a,UN:()=>o}),i=r(84770);let s="aes-256-cbc";function o(e){if(!i)throw Error("Node.js crypto not available");let t=Buffer.from(process.env.EMAIL_AES_KEY,"hex"),r=i.randomBytes(16),o=i.createCipheriv(s,t,r),a=o.update(e,"utf8","hex");return a+=o.final("hex"),r.toString("hex")+":"+a}function a(e){if(!i)throw Error("Node.js crypto not available");let t=Buffer.from(process.env.EMAIL_AES_KEY,"hex"),[r,o]=e.split(":"),a=Buffer.from(r,"hex"),n=i.createDecipheriv(s,t,a);return n.update(o,"hex","utf8")+n.final("utf8")}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[9276,5972,1482,7060,429],()=>r(61772));module.exports=i})();