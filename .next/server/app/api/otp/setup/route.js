"use strict";(()=>{var e={};e.id=1887,e.ids=[1887],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},71568:e=>{e.exports=require("zlib")},69952:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>q,requestAsyncStorage:()=>x,routeModule:()=>h,serverHooks:()=>y,staticGenerationAsyncStorage:()=>S});var o={};r.r(o),r.d(o,{OPTIONS:()=>m,POST:()=>g});var s=r(49303),n=r(88716),a=r(60670),i=r(87070),u=r(10429),p=r(28362),l=r(45256),c=r(32646),d=r(71732),f=r(58543);async function m(){return new i.NextResponse(null,{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"}})}async function g(e){let t;await (0,l.X)();let o=e.cookies.get("token")?.value;if(!o)return i.NextResponse.json({message:"Unauthorized"},{status:401});try{let e=r(41482);if(!process.env.JWT_SECRET)return i.NextResponse.json({message:"서버 설정 오류: JWT_SECRET이 정의되지 않았습니다."},{status:500});t=e.verify(o,process.env.JWT_SECRET)}catch(e){return i.NextResponse.json({message:"유효하지 않은 토큰입니다."},{status:403})}let s=t?.email?.toLowerCase().trim();if(!s)return i.NextResponse.json({message:"Unauthorized"},{status:401});let n=s;if(n&&n.includes(":"))try{n=(0,f.LJ)(n)}catch{}let a=await c.Z.findOne({email:s});if(!a)return await d.Z.findOne({email:s})?i.NextResponse.json({message:"이미 인증된 계정입니다. 로그인 후 OTP 인증을 진행하세요."},{status:400}):i.NextResponse.json({message:"임시 회원 정보가 없습니다. 회원가입을 다시 진행해 주세요."},{status:404});let m=a.otpSecret;if(m&&m.includes(":"))try{m=(0,f.LJ)(m)}catch{}let g=u.otpauthURL({secret:m,label:`${n}`,issuer:"SignChain",encoding:"base32"});try{let e=await p.toDataURL(g);return i.NextResponse.json({qrCodeUrl:e,otpSecret:m})}catch(e){return i.NextResponse.json({message:"QR 코드 생성 실패",error:e.message},{status:500})}}let h=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/otp/setup/route",pathname:"/api/otp/setup",filename:"route",bundlePath:"app/api/otp/setup/route"},resolvedPagePath:"E:\\test2\\app\\api\\otp\\setup\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:x,staticGenerationAsyncStorage:S,serverHooks:y}=h,v="/api/otp/setup/route";function q(){return(0,a.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:S})}},45256:(e,t,r)=>{let o;r.d(t,{X:()=>i});var s=r(11185),n=r.n(s);let a=process.env.MONGODB_URI;if(!a)throw Error("MongoDB URI가 .env에 설정되어 있지 않습니다.");async function i(){o.conn&&o.conn.readyState>=1||(o.promise||(o.promise=n().connect(a).then(e=>e.connection)),o.conn=await o.promise)}global.mongoose?o=global.mongoose:(o={conn:null,promise:null},global.mongoose=o)},32646:(e,t,r)=>{r.d(t,{Z:()=>a});var o=r(11185),s=r.n(o);let n=new(s()).Schema({email:{type:String,required:!0},username:{type:String,required:!0},password:{type:String,required:!0},otpSecret:{type:String,required:!0},createdAt:{type:Date,default:Date.now,expires:300}}),a=s().models.TempUser||s().model("TempUser",n)},71732:(e,t,r)=>{r.d(t,{Z:()=>a});var o=r(11185),s=r.n(o);let n=new o.Schema({username:{type:String,required:!0,unique:!0},email:{type:String,required:!0,unique:!0},password:{type:String,required:!0},publicKey:{type:String},certificate:{type:String},otpEnabled:{type:Boolean,default:!1},otpSecret:{type:String},otpVerified:{type:Boolean,default:!1},certificateStatus:{type:String,default:"valid"},currentRefreshJti:{type:String}}),a=s().models.User||s().model("User",n)},58543:(e,t,r)=>{let o;r.d(t,{LJ:()=>a,UN:()=>n}),o=r(84770);let s="aes-256-cbc";function n(e){if(!o)throw Error("Node.js crypto not available");let t=Buffer.from(process.env.EMAIL_AES_KEY,"hex"),r=o.randomBytes(16),n=o.createCipheriv(s,t,r),a=n.update(e,"utf8","hex");return a+=n.final("hex"),r.toString("hex")+":"+a}function a(e){if(!o)throw Error("Node.js crypto not available");let t=Buffer.from(process.env.EMAIL_AES_KEY,"hex"),[r,n]=e.split(":"),a=Buffer.from(r,"hex"),i=o.createDecipheriv(s,t,a);return i.update(n,"hex","utf8")+i.final("utf8")}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[9276,5972,1482,429,8362],()=>r(69952));module.exports=o})();