"use strict";(()=>{var e={};e.id=793,e.ids=[793],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},19912:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>v,requestAsyncStorage:()=>m,routeModule:()=>y,serverHooks:()=>h,staticGenerationAsyncStorage:()=>S});var i={};r.r(i),r.d(i,{OPTIONS:()=>c,POST:()=>l});var n=r(49303),s=r(88716),a=r(60670),o=r(87070),d=r(45256),p=r(20975),g=r(37060),u=r.n(g);async function l(e){await (0,d.X)();try{let{contractId:t}=await e.json(),r=await p.Z.findById(t);if(!r)return o.NextResponse.json({signed:!1,message:"Contract not found"},{status:404});let i=r.security?.fileHash;if(!i)return o.NextResponse.json({signed:!1,message:"No contract hash to sign"},{status:400});let n=process.env.PRIVATE_KEY;if(!n)return o.NextResponse.json({message:"서버에 개인키가 설정되어 있지 않습니다."},{status:500});let s=u().pki.privateKeyFromPem(n),a=u().md.sha256.create();return a.update(i,"utf8"),s.sign(a),r.signature||(r.signature={signed:!1}),r.signature.signed=!0,await r.save(),o.NextResponse.json({signed:!0})}catch(e){return o.NextResponse.json({signed:!1,message:"Server error"},{status:500})}}async function c(){return o.NextResponse.json({},{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"}})}let y=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/digital-sign/digital-sign/route",pathname:"/api/digital-sign/digital-sign",filename:"route",bundlePath:"app/api/digital-sign/digital-sign/route"},resolvedPagePath:"E:\\test2\\app\\api\\digital-sign\\digital-sign\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:m,staticGenerationAsyncStorage:S,serverHooks:h}=y,f="/api/digital-sign/digital-sign/route";function v(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:S})}},23634:(e,t,r)=>{var i;r.d(t,{r:()=>i}),function(e){e.Uploaded="uploaded",e.Signed="signed",e.Expired="expired",e.Rejected="rejected"}(i||(i={}))},45256:(e,t,r)=>{let i;r.d(t,{X:()=>o});var n=r(11185),s=r.n(n);let a=process.env.MONGODB_URI;if(!a)throw Error("MongoDB URI가 .env에 설정되어 있지 않습니다.");async function o(){i.conn&&i.conn.readyState>=1||(i.promise||(i.promise=s().connect(a).then(e=>e.connection)),i.conn=await i.promise)}global.mongoose?i=global.mongoose:(i={conn:null,promise:null},global.mongoose=i)},20975:(e,t,r)=>{r.d(t,{Z:()=>p});var i=r(11185),n=r.n(i),s=r(23634);let a=new i.Schema({signed:{type:Boolean,default:!1},signer:{type:String},certificate:{type:String},signatureImageHash:{type:String},signatureImageDigital:{type:String},signature:{type:String},signatureImageHashSignature:{type:String},qrCode:{type:String}},{_id:!1}),o=new i.Schema({fileHash:{type:String,required:!0},encryptedAesKeyForUploader:{type:String,required:!0},encryptedAesKeyForRecipient:{type:String,required:!0}},{_id:!1}),d=new i.Schema({title:{type:String,required:!0},uploaderId:{type:String,required:!0},recipientId:{type:String,required:!0},senderEmail:{type:String},recipientEmail:{type:String},filePath:{type:String,required:!0},status:{type:String,required:!0,default:s.r.Uploaded,enum:Object.values(s.r)},expirationDate:{type:Date,required:!0},received:{type:Boolean,default:!1},deletedBy:{type:[String],default:[]},security:{type:o,required:!0},signature:{type:a,default:void 0}},{timestamps:!0}),p=n().models.Contract||n().model("Contract",d)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[9276,5972,7060],()=>r(19912));module.exports=i})();