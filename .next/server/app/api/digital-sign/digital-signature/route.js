"use strict";(()=>{var e={};e.id=3522,e.ids=[3522],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},98279:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>f,patchFetch:()=>h,requestAsyncStorage:()=>y,routeModule:()=>c,serverHooks:()=>m,staticGenerationAsyncStorage:()=>S});var i={};r.r(i),r.d(i,{OPTIONS:()=>l,POST:()=>g});var n=r(49303),a=r(88716),s=r(60670),o=r(87070),d=r(45256),u=r(71732),p=r(20975);async function g(e){await (0,d.X)();try{let{email:t,hash:r,contractId:i,signature:n}=await e.json(),a=await u.Z.findOne({email:t});if(!a)return o.NextResponse.json({message:"User not found"},{status:404});if("valid"!==a.certificateStatus)return o.NextResponse.json({message:"인증서가 만료(또는 폐기)되어 전자서명이 불가합니다."},{status:403});return i&&n&&await p.Z.findByIdAndUpdate(i,{signature:{signed:!0,signer:t},status:"signed"},{new:!0}),o.NextResponse.json({message:"Digital signature saved",signature:n})}catch(e){return console.error("전자 서명 오류:",e),o.NextResponse.json({message:"Server error"},{status:500})}}async function l(){return o.NextResponse.json({},{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"}})}let c=new n.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/digital-sign/digital-signature/route",pathname:"/api/digital-sign/digital-signature",filename:"route",bundlePath:"app/api/digital-sign/digital-signature/route"},resolvedPagePath:"E:\\test2\\app\\api\\digital-sign\\digital-signature\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:y,staticGenerationAsyncStorage:S,serverHooks:m}=c,f="/api/digital-sign/digital-signature/route";function h(){return(0,s.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:S})}},23634:(e,t,r)=>{var i;r.d(t,{r:()=>i}),function(e){e.Uploaded="uploaded",e.Signed="signed",e.Expired="expired",e.Rejected="rejected"}(i||(i={}))},45256:(e,t,r)=>{let i;r.d(t,{X:()=>o});var n=r(11185),a=r.n(n);let s=process.env.MONGODB_URI;if(!s)throw Error("MongoDB URI가 .env에 설정되어 있지 않습니다.");async function o(){i.conn&&i.conn.readyState>=1||(i.promise||(i.promise=a().connect(s).then(e=>e.connection)),i.conn=await i.promise)}global.mongoose?i=global.mongoose:(i={conn:null,promise:null},global.mongoose=i)},20975:(e,t,r)=>{r.d(t,{Z:()=>u});var i=r(11185),n=r.n(i),a=r(23634);let s=new i.Schema({signed:{type:Boolean,default:!1},signer:{type:String},certificate:{type:String},signatureImageHash:{type:String},signatureImageDigital:{type:String},signature:{type:String},signatureImageHashSignature:{type:String},qrCode:{type:String}},{_id:!1}),o=new i.Schema({fileHash:{type:String,required:!0},encryptedAesKeyForUploader:{type:String,required:!0},encryptedAesKeyForRecipient:{type:String,required:!0}},{_id:!1}),d=new i.Schema({title:{type:String,required:!0},uploaderId:{type:String,required:!0},recipientId:{type:String,required:!0},senderEmail:{type:String},recipientEmail:{type:String},filePath:{type:String,required:!0},status:{type:String,required:!0,default:a.r.Uploaded,enum:Object.values(a.r)},expirationDate:{type:Date,required:!0},received:{type:Boolean,default:!1},deletedBy:{type:[String],default:[]},security:{type:o,required:!0},signature:{type:s,default:void 0}},{timestamps:!0}),u=n().models.Contract||n().model("Contract",d)},71732:(e,t,r)=>{r.d(t,{Z:()=>s});var i=r(11185),n=r.n(i);let a=new i.Schema({username:{type:String,required:!0,unique:!0},email:{type:String,required:!0,unique:!0},password:{type:String,required:!0},publicKey:{type:String},certificate:{type:String},otpEnabled:{type:Boolean,default:!1},otpSecret:{type:String},otpVerified:{type:Boolean,default:!1},certificateStatus:{type:String,default:"valid"},currentRefreshJti:{type:String}}),s=n().models.User||n().model("User",a)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),i=t.X(0,[9276,5972],()=>r(98279));module.exports=i})();