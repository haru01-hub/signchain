"use strict";(()=>{var e={};e.id=3002,e.ids=[3002],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},91188:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>w,patchFetch:()=>T,requestAsyncStorage:()=>E,routeModule:()=>y,serverHooks:()=>R,staticGenerationAsyncStorage:()=>v});var o={};r.r(o),r.d(o,{OPTIONS:()=>x,POST:()=>h});var s=r(49303),n=r(88716),a=r(60670),i=r(87070),u=r(98691),p=r(71732),l=r(45256),c=r(10429),d=r(41482),m=r.n(d),g=r(32646),f=r(58543),S=r(84770);async function h(e){await (0,l.X)();let{email:t,username:r,password:o}=await e.json();if(!t||!r||!o)return i.NextResponse.json({message:"모든 필드가 필요합니다."},{status:400});try{let e=await p.Z.find({}),s=e.some(e=>!!e.email&&"string"==typeof e.email&&e.email.includes(":")&&(()=>{try{return(0,f.LJ)(e.email)===t}catch{return!1}})()),n=e.some(e=>e.username===r);if(s||n)return i.NextResponse.json({message:"이미 사용 중인 이메일 또는 사용자 이름입니다."},{status:400});let a=await u.ZP.hash(o,10),l=c.generateSecret({length:20}),d=(0,f.UN)(t),h=(0,f.UN)(l.base32);if(await g.Z.create({email:d,username:r,password:a,otpSecret:h}),!process.env.JWT_SECRET)return i.NextResponse.json({message:"서버 설정 오류: JWT_SECRET이 정의되지 않았습니다."},{status:500});let x=m().sign({id:d,email:d},process.env.JWT_SECRET,{expiresIn:"1h"}),y=process.env.REFRESH_JWT_SECRET||"default_refresh_secret",E=(0,S.randomUUID)(),v=m().sign({id:d,jti:E},y,{expiresIn:"14d"}),R=i.NextResponse.json({message:"회원가입 성공. OTP 인증을 완료해야 정보가 저장됩니다.",redirectTo:"/otp/setup",info:"OTP 인증까지 마치지 않으면 입력 정보는 저장되지 않습니다."},{status:201});return R.headers.append("Set-Cookie",`token=${x}; HttpOnly; Path=/; Max-Age=3600; Secure=true; SameSite=Strict`),R.headers.append("Set-Cookie",`refresh_token=${v}; HttpOnly; Path=/; Max-Age=1209600; Secure=true; SameSite=Strict`),R}catch(e){return console.error("[REGISTER ERROR]",e),i.NextResponse.json({message:"서버 오류",error:e.message,info:"회원가입 중단/실패 시 입력 정보는 저장되지 않습니다."},{status:500})}}async function x(){return i.NextResponse.json({},{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"}})}let y=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/auth/register/route",pathname:"/api/auth/register",filename:"route",bundlePath:"app/api/auth/register/route"},resolvedPagePath:"E:\\test2\\app\\api\\auth\\register\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:E,staticGenerationAsyncStorage:v,serverHooks:R}=y,w="/api/auth/register/route";function T(){return(0,a.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:v})}},45256:(e,t,r)=>{let o;r.d(t,{X:()=>i});var s=r(11185),n=r.n(s);let a=process.env.MONGODB_URI;if(!a)throw Error("MongoDB URI가 .env에 설정되어 있지 않습니다.");async function i(){o.conn&&o.conn.readyState>=1||(o.promise||(o.promise=n().connect(a).then(e=>e.connection)),o.conn=await o.promise)}global.mongoose?o=global.mongoose:(o={conn:null,promise:null},global.mongoose=o)},32646:(e,t,r)=>{r.d(t,{Z:()=>a});var o=r(11185),s=r.n(o);let n=new(s()).Schema({email:{type:String,required:!0},username:{type:String,required:!0},password:{type:String,required:!0},otpSecret:{type:String,required:!0},createdAt:{type:Date,default:Date.now,expires:300}}),a=s().models.TempUser||s().model("TempUser",n)},71732:(e,t,r)=>{r.d(t,{Z:()=>a});var o=r(11185),s=r.n(o);let n=new o.Schema({username:{type:String,required:!0,unique:!0},email:{type:String,required:!0,unique:!0},password:{type:String,required:!0},publicKey:{type:String},certificate:{type:String},otpEnabled:{type:Boolean,default:!1},otpSecret:{type:String},otpVerified:{type:Boolean,default:!1},certificateStatus:{type:String,default:"valid"},currentRefreshJti:{type:String}}),a=s().models.User||s().model("User",n)},58543:(e,t,r)=>{let o;r.d(t,{LJ:()=>a,UN:()=>n}),o=r(84770);let s="aes-256-cbc";function n(e){if(!o)throw Error("Node.js crypto not available");let t=Buffer.from(process.env.EMAIL_AES_KEY,"hex"),r=o.randomBytes(16),n=o.createCipheriv(s,t,r),a=n.update(e,"utf8","hex");return a+=n.final("hex"),r.toString("hex")+":"+a}function a(e){if(!o)throw Error("Node.js crypto not available");let t=Buffer.from(process.env.EMAIL_AES_KEY,"hex"),[r,n]=e.split(":"),a=Buffer.from(r,"hex"),i=o.createDecipheriv(s,t,a);return i.update(n,"hex","utf8")+i.final("utf8")}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[9276,5972,1482,429,8691],()=>r(91188));module.exports=o})();