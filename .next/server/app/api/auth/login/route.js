"use strict";(()=>{var e={};e.id=8873,e.ids=[8873],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},91759:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>E,patchFetch:()=>A,requestAsyncStorage:()=>v,routeModule:()=>x,serverHooks:()=>R,staticGenerationAsyncStorage:()=>w});var a={};r.r(a),r.d(a,{OPTIONS:()=>y,POST:()=>h});var i=r(49303),o=r(88716),s=r(60670),n=r(87070),u=r(98691),p=r(41482),c=r.n(p),l=r(45256),d=r(71732),m=r(37060),f=r.n(m),g=r(58543),S=r(84770);async function h(e){await (0,l.X)();let{email:t,password:a}=await e.json();if(!t||!a)return n.NextResponse.json({message:"이메일, 비밀번호 모두 필요합니다."},{status:400});try{let e=t.trim().toLowerCase(),i=(await d.Z.find({})).find(t=>(0,g.LJ)(t.email)===e);if(!i)return n.NextResponse.json({message:"등록되지 않은 이메일입니다."},{status:401});if(!await u.ZP.compare(a,i.password))return n.NextResponse.json({message:"비밀번호가 틀렸습니다."},{status:401});if(!i.certificate)return n.NextResponse.json({message:"인증서가 없습니다."},{status:400});{let e=f().pki.certificateFromPem(i.certificate);if(new Date>e.validity.notAfter)return i.certificateStatus="expired",await i.save(),n.NextResponse.json({message:"인증서가 만료되었습니다. 재발급이 필요합니다."},{status:403});"valid"!==i.certificateStatus&&(i.certificateStatus="valid",await i.save())}let o=process.env.JWT_SECRET||"default_jwt_secret",s=process.env.REFRESH_JWT_SECRET||"default_refresh_secret",p=(0,S.randomUUID)(),l=(0,g.LJ)(i.email).trim().toLowerCase(),m=c().sign({id:i._id,otpVerified:i.otpVerified,certificateStatus:i.certificateStatus,email:l,username:i.username},o,{expiresIn:"1h"}),h=c().sign({id:i._id,jti:p},s,{expiresIn:"14d"});i.currentRefreshJti=p,await i.save();let y=n.NextResponse.json({message:"로그인 성공",redirectTo:"/otp/verify?mode=login",userId:i._id});y.headers.append("Set-Cookie",`token=${m}; HttpOnly; Path=/; Max-Age=3600; Secure=true; SameSite=Strict`),y.headers.append("Set-Cookie",`refresh_token=${h}; HttpOnly; Path=/; Max-Age=1209600; Secure=true; SameSite=Strict`);let x=r(36454).Z;return await x.create({recipientEmail:"string"==typeof l&&l.includes(":")?l:(0,g.UN)(l),message:`로그인: ${new Date().toLocaleString("ko-KR",{hour12:!1})}`,timestamp:new Date,read:!1,type:"system"}),y}catch(e){return console.error("[LOGIN ERROR]",e),n.NextResponse.json({message:"서버 오류가 발생했습니다: "+e.message},{status:500})}}async function y(){return n.NextResponse.json({},{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"}})}let x=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/auth/login/route",pathname:"/api/auth/login",filename:"route",bundlePath:"app/api/auth/login/route"},resolvedPagePath:"E:\\test2\\app\\api\\auth\\login\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:v,staticGenerationAsyncStorage:w,serverHooks:R}=x,E="/api/auth/login/route";function A(){return(0,s.patchFetch)({serverHooks:R,staticGenerationAsyncStorage:w})}},45256:(e,t,r)=>{let a;r.d(t,{X:()=>n});var i=r(11185),o=r.n(i);let s=process.env.MONGODB_URI;if(!s)throw Error("MongoDB URI가 .env에 설정되어 있지 않습니다.");async function n(){a.conn&&a.conn.readyState>=1||(a.promise||(a.promise=o().connect(s).then(e=>e.connection)),a.conn=await a.promise)}global.mongoose?a=global.mongoose:(a={conn:null,promise:null},global.mongoose=a)},36454:(e,t,r)=>{r.d(t,{Z:()=>s});var a=r(11185),i=r.n(a);let o=new a.Schema({recipientEmail:{type:String,required:!0},message:{type:String,required:!0},timestamp:{type:Date,default:Date.now},read:{type:Boolean,default:!1},type:{type:String,enum:["system","message"],default:"system"},contractId:{type:a.Schema.Types.ObjectId,ref:"Contract"},senderEmail:{type:String}}),s=i().models.Notification||i().model("Notification",o)},71732:(e,t,r)=>{r.d(t,{Z:()=>s});var a=r(11185),i=r.n(a);let o=new a.Schema({username:{type:String,required:!0,unique:!0},email:{type:String,required:!0,unique:!0},password:{type:String,required:!0},publicKey:{type:String},certificate:{type:String},otpEnabled:{type:Boolean,default:!1},otpSecret:{type:String},otpVerified:{type:Boolean,default:!1},certificateStatus:{type:String,default:"valid"},currentRefreshJti:{type:String}}),s=i().models.User||i().model("User",o)},58543:(e,t,r)=>{let a;r.d(t,{LJ:()=>s,UN:()=>o}),a=r(84770);let i="aes-256-cbc";function o(e){if(!a)throw Error("Node.js crypto not available");let t=Buffer.from(process.env.EMAIL_AES_KEY,"hex"),r=a.randomBytes(16),o=a.createCipheriv(i,t,r),s=o.update(e,"utf8","hex");return s+=o.final("hex"),r.toString("hex")+":"+s}function s(e){if(!a)throw Error("Node.js crypto not available");let t=Buffer.from(process.env.EMAIL_AES_KEY,"hex"),[r,o]=e.split(":"),s=Buffer.from(r,"hex"),n=a.createDecipheriv(i,t,s);return n.update(o,"hex","utf8")+n.final("utf8")}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[9276,5972,1482,7060,8691],()=>r(91759));module.exports=a})();