"use strict";(()=>{var e={};e.id=5756,e.ids=[5756],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},37705:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>j,patchFetch:()=>N,requestAsyncStorage:()=>E,routeModule:()=>x,serverHooks:()=>v,staticGenerationAsyncStorage:()=>w});var n={};r.r(n),r.d(n,{DELETE:()=>h,GET:()=>f,OPTIONS:()=>y,PATCH:()=>g});var s=r(49303),o=r(88716),a=r(60670),i=r(87070),u=r(36454),c=r(45256),p=r(41482),l=r.n(p),m=r(58543);async function d(e){let t=e.cookies.get("token")?.value;if(!t||!process.env.JWT_SECRET)return null;try{return l().verify(t,process.env.JWT_SECRET)}catch{return null}}async function f(e){await (0,c.X)();let t=await d(e);if(!t)return i.NextResponse.json({message:"인증 정보가 없습니다."},{status:401});try{let e=t?.email?.trim().toLowerCase(),r=(await u.Z.find({}).sort({timestamp:-1}).limit(50).lean()).filter(t=>{try{return(0,m.LJ)(t.recipientEmail).trim().toLowerCase()===e}catch{return!1}}).map(e=>({...e,recipientEmail:(0,m.LJ)(e.recipientEmail),senderEmail:e.senderEmail?(0,m.LJ)(e.senderEmail):void 0,id:e._id.toString()}));return i.NextResponse.json({notifications:r})}catch(e){return i.NextResponse.json({message:"알림을 가져오는 중 오류 발생",error:e.message},{status:500})}}async function g(e){if(await (0,c.X)(),!await d(e))return i.NextResponse.json({message:"인증 정보가 없습니다."},{status:401});try{let{id:t}=await e.json();if(!t)return i.NextResponse.json({message:"id가 필요합니다."},{status:400});return await u.Z.findByIdAndUpdate(t,{read:!0}),i.NextResponse.json({message:"알림 읽음 처리 완료"})}catch(e){return i.NextResponse.json({message:"알림 읽음 처리 중 오류 발생",error:e.message},{status:500})}}async function h(e){await (0,c.X)();let t=await d(e);if(!t)return i.NextResponse.json({message:"인증 정보가 없습니다."},{status:401});try{let{id:r,all:n}=await e.json();if(n){let e=await u.Z.find({}),r=t?.email?.trim().toLowerCase(),n=e.filter(e=>{try{return(0,m.LJ)(e.recipientEmail).trim().toLowerCase()===r}catch{return!1}}).map(e=>e._id);return await u.Z.deleteMany({_id:{$in:n}}),i.NextResponse.json({message:"전체 알림 삭제 완료"})}if(!r)return i.NextResponse.json({message:"id가 필요합니다."},{status:400});return await u.Z.findByIdAndDelete(r),i.NextResponse.json({message:"알림 삭제 완료"})}catch(e){return i.NextResponse.json({message:"알림 삭제 중 오류 발생",error:e.message},{status:500})}}async function y(){return i.NextResponse.json({},{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, PATCH, DELETE, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"}})}let x=new s.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/auth/notifications/route",pathname:"/api/auth/notifications",filename:"route",bundlePath:"app/api/auth/notifications/route"},resolvedPagePath:"E:\\test2\\app\\api\\auth\\notifications\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:E,staticGenerationAsyncStorage:w,serverHooks:v}=x,j="/api/auth/notifications/route";function N(){return(0,a.patchFetch)({serverHooks:v,staticGenerationAsyncStorage:w})}},45256:(e,t,r)=>{let n;r.d(t,{X:()=>i});var s=r(11185),o=r.n(s);let a=process.env.MONGODB_URI;if(!a)throw Error("MongoDB URI가 .env에 설정되어 있지 않습니다.");async function i(){n.conn&&n.conn.readyState>=1||(n.promise||(n.promise=o().connect(a).then(e=>e.connection)),n.conn=await n.promise)}global.mongoose?n=global.mongoose:(n={conn:null,promise:null},global.mongoose=n)},36454:(e,t,r)=>{r.d(t,{Z:()=>a});var n=r(11185),s=r.n(n);let o=new n.Schema({recipientEmail:{type:String,required:!0},message:{type:String,required:!0},timestamp:{type:Date,default:Date.now},read:{type:Boolean,default:!1},type:{type:String,enum:["system","message"],default:"system"},contractId:{type:n.Schema.Types.ObjectId,ref:"Contract"},senderEmail:{type:String}}),a=s().models.Notification||s().model("Notification",o)},58543:(e,t,r)=>{let n;r.d(t,{LJ:()=>a,UN:()=>o}),n=r(84770);let s="aes-256-cbc";function o(e){if(!n)throw Error("Node.js crypto not available");let t=Buffer.from(process.env.EMAIL_AES_KEY,"hex"),r=n.randomBytes(16),o=n.createCipheriv(s,t,r),a=o.update(e,"utf8","hex");return a+=o.final("hex"),r.toString("hex")+":"+a}function a(e){if(!n)throw Error("Node.js crypto not available");let t=Buffer.from(process.env.EMAIL_AES_KEY,"hex"),[r,o]=e.split(":"),a=Buffer.from(r,"hex"),i=n.createDecipheriv(s,t,a);return i.update(o,"hex","utf8")+i.final("utf8")}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[9276,5972,1482],()=>r(37705));module.exports=n})();