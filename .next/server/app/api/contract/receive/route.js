"use strict";(()=>{var e={};e.id=2078,e.ids=[2078],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},38686:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>q,patchFetch:()=>R,requestAsyncStorage:()=>v,routeModule:()=>f,serverHooks:()=>h,staticGenerationAsyncStorage:()=>x});var n={};r.r(n),r.d(n,{OPTIONS:()=>m,PATCH:()=>S,POST:()=>y});var i=r(49303),o=r(88716),a=r(60670),s=r(87070),d=r(45256),u=r(20975),p=r(41482),c=r.n(p),l=r(23634);async function g(e){let t=e.cookies.get("token")?.value;if(!t||!process.env.JWT_SECRET)return null;try{return c().verify(t,process.env.JWT_SECRET)}catch{return null}}async function y(e){return S(e)}async function m(){return s.NextResponse.json({},{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"}})}async function S(e){await (0,d.X)();let t=await g(e);if(!t)return s.NextResponse.json({message:"Unauthorized"},{status:401});let r=await e.json(),{contractId:n,received:i,status:o,deleted:a}=r;if(!n)return s.NextResponse.json({message:"contractId required"},{status:400});let p=await u.Z.findById(n);if(!p)return s.NextResponse.json({message:"Contract not found"},{status:404});"boolean"==typeof i&&(p.received=i),o&&(p.status=o),!1===i&&(p.status=l.r.Rejected);let c="string"==typeof t?t:t.id||t.sub||"";return r.deletedBy&&(p.deletedBy=Array.from(new Set([...p.deletedBy||[],c.toString()])),r.deletedBy&&c===String(p.recipientId)&&(p.deletedBy=Array.from(new Set([...p.deletedBy||[],c.toString()])),p.status!==l.r.Signed&&(p.status=l.r.Rejected,p.received=!1),p.deletedBy.map(String).includes(String(p.uploaderId))&&p.deletedBy.map(String).includes(String(p.recipientId))))?(await u.Z.findByIdAndDelete(n),s.NextResponse.json({message:"계약서 완전 삭제"})):"boolean"==typeof a&&!0===a?(p.status=l.r.Rejected,await p.save(),s.NextResponse.json({message:"수신자가 계약을 삭제하여 거부 처리됨",status:l.r.Rejected})):(await p.save(),s.NextResponse.json({message:"Contract updated",received:p.received,status:p.status,deletedBy:p.deletedBy}))}let f=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/contract/receive/route",pathname:"/api/contract/receive",filename:"route",bundlePath:"app/api/contract/receive/route"},resolvedPagePath:"E:\\test2\\app\\api\\contract\\receive\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:v,staticGenerationAsyncStorage:x,serverHooks:h}=f,q="/api/contract/receive/route";function R(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:x})}},23634:(e,t,r)=>{var n;r.d(t,{r:()=>n}),function(e){e.Uploaded="uploaded",e.Signed="signed",e.Expired="expired",e.Rejected="rejected"}(n||(n={}))},45256:(e,t,r)=>{let n;r.d(t,{X:()=>s});var i=r(11185),o=r.n(i);let a=process.env.MONGODB_URI;if(!a)throw Error("MongoDB URI가 .env에 설정되어 있지 않습니다.");async function s(){n.conn&&n.conn.readyState>=1||(n.promise||(n.promise=o().connect(a).then(e=>e.connection)),n.conn=await n.promise)}global.mongoose?n=global.mongoose:(n={conn:null,promise:null},global.mongoose=n)},20975:(e,t,r)=>{r.d(t,{Z:()=>u});var n=r(11185),i=r.n(n),o=r(23634);let a=new n.Schema({signed:{type:Boolean,default:!1},signer:{type:String},certificate:{type:String},signatureImageHash:{type:String},signatureImageDigital:{type:String},signature:{type:String},signatureImageHashSignature:{type:String},qrCode:{type:String}},{_id:!1}),s=new n.Schema({fileHash:{type:String,required:!0},encryptedAesKeyForUploader:{type:String,required:!0},encryptedAesKeyForRecipient:{type:String,required:!0}},{_id:!1}),d=new n.Schema({title:{type:String,required:!0},uploaderId:{type:String,required:!0},recipientId:{type:String,required:!0},senderEmail:{type:String},recipientEmail:{type:String},filePath:{type:String,required:!0},status:{type:String,required:!0,default:o.r.Uploaded,enum:Object.values(o.r)},expirationDate:{type:Date,required:!0},received:{type:Boolean,default:!1},deletedBy:{type:[String],default:[]},security:{type:s,required:!0},signature:{type:a,default:void 0}},{timestamps:!0}),u=i().models.Contract||i().model("Contract",d)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[9276,5972,1482],()=>r(38686));module.exports=n})();