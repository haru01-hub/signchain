"use strict";(()=>{var e={};e.id=8478,e.ids=[8478],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},57468:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>v,patchFetch:()=>h,requestAsyncStorage:()=>f,routeModule:()=>y,serverHooks:()=>S,staticGenerationAsyncStorage:()=>x});var n={};r.r(n),r.d(n,{GET:()=>m});var i=r(49303),s=r(88716),o=r(60670),a=r(87070),p=r(45256),u=r(20975),d=r(92048),c=r(55315),l=r.n(c),g=r(23634);async function m(e,t){await (0,p.X)();let n=t.params.id,i=await u.Z.findById(n);if(!i)return a.NextResponse.json({message:"Contract not found"},{status:404});if(i.expirationDate<new Date&&i.status!==g.r.Expired&&(i.status=g.r.Expired,await i.save()),i.status===g.r.Expired)return a.NextResponse.json({message:"계약서가 만료되었습니다."},{status:403});let s="",o=e.cookies.get("token")?.value;if(!o||!process.env.JWT_SECRET)return a.NextResponse.json({message:"인증이 필요합니다."},{status:401});try{let e=r(41482).verify(o,process.env.JWT_SECRET);"object"==typeof e&&null!==e&&(s=e.id||e._id||e.userId||"")}catch{return a.NextResponse.json({message:"유효하지 않은 토큰입니다."},{status:401})}let c=l().join(process.cwd(),"previews"),m=!1,y="",f="";for(let e of["pdf","txt","docx"]){let t=l().join(c,`${n}.${e}`);if((0,d.existsSync)(t)){y=t,f=e,m=!0;break}}if(!m)return a.NextResponse.json({message:"미리보기 파일이 없습니다."},{status:404});if("rejected"===i.status&&s===i.recipientId?.toString())return a.NextResponse.json({message:"계약서가 반려되어 더 이상 열람할 수 없습니다."},{status:403});try{let e=(0,d.readFileSync)(y);if("txt"===f||"docx"===f)return a.NextResponse.json({preview:e.toString("utf-8"),filename:`${n}.${f}`});if("pdf"===f)return new Response(e,{status:200,headers:{"Content-Type":"application/pdf","Content-Disposition":`inline; filename="${n}.pdf"`,"Cache-Control":"no-store","Access-Control-Allow-Origin":"*"}});return a.NextResponse.json({message:"미리보기를 지원하지 않는 파일 형식입니다."},{status:400})}catch(e){return a.NextResponse.json({message:"미리보기 파일 읽기 실패"},{status:500})}}let y=new i.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/contract/[id]/preview/route",pathname:"/api/contract/[id]/preview",filename:"route",bundlePath:"app/api/contract/[id]/preview/route"},resolvedPagePath:"E:\\test2\\app\\api\\contract\\[id]\\preview\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:f,staticGenerationAsyncStorage:x,serverHooks:S}=y,v="/api/contract/[id]/preview/route";function h(){return(0,o.patchFetch)({serverHooks:S,staticGenerationAsyncStorage:x})}},23634:(e,t,r)=>{var n;r.d(t,{r:()=>n}),function(e){e.Uploaded="uploaded",e.Signed="signed",e.Expired="expired",e.Rejected="rejected"}(n||(n={}))},45256:(e,t,r)=>{let n;r.d(t,{X:()=>a});var i=r(11185),s=r.n(i);let o=process.env.MONGODB_URI;if(!o)throw Error("MongoDB URI가 .env에 설정되어 있지 않습니다.");async function a(){n.conn&&n.conn.readyState>=1||(n.promise||(n.promise=s().connect(o).then(e=>e.connection)),n.conn=await n.promise)}global.mongoose?n=global.mongoose:(n={conn:null,promise:null},global.mongoose=n)},20975:(e,t,r)=>{r.d(t,{Z:()=>u});var n=r(11185),i=r.n(n),s=r(23634);let o=new n.Schema({signed:{type:Boolean,default:!1},signer:{type:String},certificate:{type:String},signatureImageHash:{type:String},signatureImageDigital:{type:String},signature:{type:String},signatureImageHashSignature:{type:String},qrCode:{type:String}},{_id:!1}),a=new n.Schema({fileHash:{type:String,required:!0},encryptedAesKeyForUploader:{type:String,required:!0},encryptedAesKeyForRecipient:{type:String,required:!0}},{_id:!1}),p=new n.Schema({title:{type:String,required:!0},uploaderId:{type:String,required:!0},recipientId:{type:String,required:!0},senderEmail:{type:String},recipientEmail:{type:String},filePath:{type:String,required:!0},status:{type:String,required:!0,default:s.r.Uploaded,enum:Object.values(s.r)},expirationDate:{type:Date,required:!0},received:{type:Boolean,default:!1},deletedBy:{type:[String],default:[]},security:{type:a,required:!0},signature:{type:o,default:void 0}},{timestamps:!0}),u=i().models.Contract||i().model("Contract",p)}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[9276,5972,1482],()=>r(57468));module.exports=n})();