"use strict";(()=>{var e={};e.id=5386,e.ids=[5386],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},10569:(e,t,s)=>{s.r(t),s.d(t,{originalPathname:()=>H,patchFetch:()=>O,requestAsyncStorage:()=>P,routeModule:()=>B,serverHooks:()=>_,staticGenerationAsyncStorage:()=>D});var a={};s.r(a),s.d(a,{DELETE:()=>E,GET:()=>v,PATCH:()=>N,POST:()=>q});var r=s(49303),n=s(88716),i=s(60670),o=s(87070),d=s(45256),u=s(20975),p=s(92048),l=s(55315),c=s.n(l),g=s(37060),m=s.n(g),y=s(96904),f=s(41482),h=s.n(f),x=s(84770),S=s.n(x),j=s(23634),R=s(11185),w=s.n(R);async function I(e){let t=e.cookies.get("token")?.value;if(!t||!process.env.JWT_SECRET)return null;try{let e=h().verify(t,process.env.JWT_SECRET);if("object"==typeof e&&null!==e)return e._id||e.id||e.userId||null;return null}catch{return null}}async function v(e,t){let s;await (0,d.X)();let a=await I(e),r=t.params.id;if(!w().Types.ObjectId.isValid(r))return o.NextResponse.json({message:"잘못된 계약 ID입니다."},{status:400});let n=await u.Z.findById(r);if(!n||n.deletedBy&&a&&n.deletedBy.map(String).includes(a))return o.NextResponse.json({message:"계약서를 찾을 수 없습니다."},{status:404});if(n.expirationDate<new Date&&n.status!==j.r.Expired&&(n.status=j.r.Expired,await n.save()),n.status===j.r.Expired)return o.NextResponse.json({message:"계약서가 만료되었습니다."},{status:400});let i=n.filePath,l=n.filePath.replace(/^[/\\]+/,""),g=c().resolve("uploads",l);try{s=(0,p.readFileSync)(g)}catch(e){return o.NextResponse.json({message:"파일을 읽을 수 없습니다."},{status:500})}let m=n.security?.fileHash,f=S().createHash("sha256").update(s).digest("hex");if(!m||f!==m)return o.NextResponse.json({message:"무결성 검증 실패: 파일이 위변조되었습니다."},{status:400});let h=await y.Z.findOne({contractId:n._id}).sort({_id:-1}),x=h?h.hash:"";await y.Z.create({contractId:n._id,filePath:n.filePath,encapsulation:"view",tag:"contract",hash:f,previousHash:x,filename:n.title});let R=s.toString("base64"),v={};try{v=JSON.parse((0,p.readFileSync)(i.replace(/\.enc$/,"-metadata.json"),"utf8"))}catch{}return o.NextResponse.json({...n.toObject(),encryptedFileBase64:R,metadata:v})}async function N(e,t){if(await (0,d.X)(),!await I(e))return o.NextResponse.json({message:"인증 필요"},{status:401});let s=t.params.id;if(!w().Types.ObjectId.isValid(s))return o.NextResponse.json({message:"잘못된 계약 ID입니다."},{status:400});let{contractHash:a,signature:r,signatureImage:n,signatureImageHash:i,signatureImageHashSignature:p,signer:l,status:c,rejectReason:g}=await e.json(),m=await u.Z.findById(s);if(!m)return o.NextResponse.json({message:"Contract not found"},{status:404});if(m.expirationDate<new Date&&m.status!==j.r.Expired&&(m.status=j.r.Expired,await m.save()),m.status===j.r.Expired)return o.NextResponse.json({message:"계약서가 만료되었습니다."},{status:400});let f=[j.r.Uploaded,j.r.Signed,j.r.Expired,j.r.Rejected];if(c&&!f.includes(c))return o.NextResponse.json({message:"유효하지 않은 상태값입니다."},{status:400});if(c===j.r.Rejected){m.status=j.r.Rejected,await m.save();let e=await y.Z.findOne({contractId:m._id}).sort({_id:-1}),t=e?e.hash:"";return await y.Z.create({contractId:m._id,filePath:m.filePath,encapsulation:"reject",tag:"contract",hash:m.security?.fileHash||"",previousHash:t,filename:m.title}),o.NextResponse.json({message:"Contract rejected"})}if(a&&r&&n&&i&&p&&l){m.signature||(m.signature={signed:!1}),m.signature.signature=r,m.signature.signatureImageDigital=n,m.signature.signatureImageHash=i,m.signature.signatureImageHashSignature=p,m.signature.signed=!0,m.signature.signer=l,m.status=j.r.Signed,await m.save();let e=await y.Z.findOne({contractId:m._id}).sort({_id:-1}),t=e?e.hash:"";return await y.Z.create({contractId:m._id,filePath:m.filePath,encapsulation:"hand-sign",tag:"contract",hash:i||m.security?.fileHash||"",previousHash:t,filename:m.title}),o.NextResponse.json({message:"Hand & digital signature saved"})}return c===j.r.Uploaded?(m.status=j.r.Uploaded,await m.save(),o.NextResponse.json({message:"상태가 업로드로 변경됨"})):c===j.r.Expired?(m.status=j.r.Expired,await m.save(),o.NextResponse.json({message:"상태가 만료로 변경됨"})):o.NextResponse.json({message:"서명 데이터가 부족합니다."},{status:400})}async function q(e,t){await (0,d.X)();let s=t.params.id;if(!w().Types.ObjectId.isValid(s))return o.NextResponse.json({message:"잘못된 계약 ID입니다."},{status:400});let{fileData:a}=await e.json(),r=await u.Z.findById(s);if(!r)return o.NextResponse.json({message:"Contract not found"},{status:404});let n=r.security?.fileHash;if(!n)return o.NextResponse.json({message:"파일 해시 정보가 없습니다."},{status:500});let i=m().md.sha256.create();return(i.update(a,"utf8"),i.digest().toHex()!==n)?o.NextResponse.json({message:"Integrity check failed"},{status:400}):o.NextResponse.json({message:"Integrity check passed"})}async function E(e,t){await (0,d.X)();let s=await I(e),a=t.params.id;if(!w().Types.ObjectId.isValid(a))return o.NextResponse.json({message:"잘못된 계약 ID입니다."},{status:400});let r=await u.Z.findById(a);return r?s?r.deletedBy&&r.deletedBy.map(String).includes(s)?o.NextResponse.json({message:"이미 삭제됨"}):(r.deletedBy=[...r.deletedBy||[],s],r.deletedBy.map(String).includes(String(r.uploaderId))&&r.deletedBy.map(String).includes(String(r.recipientId)))?(await u.Z.findByIdAndDelete(a),o.NextResponse.json({message:"계약서 완전 삭제"})):(await r.save(),o.NextResponse.json({message:"soft delete 완료"})):o.NextResponse.json({message:"인증 필요"},{status:401}):o.NextResponse.json({message:"계약서를 찾을 수 없습니다."},{status:404})}let B=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/contract/[id]/route",pathname:"/api/contract/[id]",filename:"route",bundlePath:"app/api/contract/[id]/route"},resolvedPagePath:"E:\\test2\\app\\api\\contract\\[id]\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:P,staticGenerationAsyncStorage:D,serverHooks:_}=B,H="/api/contract/[id]/route";function O(){return(0,i.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:D})}},23634:(e,t,s)=>{var a;s.d(t,{r:()=>a}),function(e){e.Uploaded="uploaded",e.Signed="signed",e.Expired="expired",e.Rejected="rejected"}(a||(a={}))},45256:(e,t,s)=>{let a;s.d(t,{X:()=>o});var r=s(11185),n=s.n(r);let i=process.env.MONGODB_URI;if(!i)throw Error("MongoDB URI가 .env에 설정되어 있지 않습니다.");async function o(){a.conn&&a.conn.readyState>=1||(a.promise||(a.promise=n().connect(i).then(e=>e.connection)),a.conn=await a.promise)}global.mongoose?a=global.mongoose:(a={conn:null,promise:null},global.mongoose=a)},20975:(e,t,s)=>{s.d(t,{Z:()=>u});var a=s(11185),r=s.n(a),n=s(23634);let i=new a.Schema({signed:{type:Boolean,default:!1},signer:{type:String},certificate:{type:String},signatureImageHash:{type:String},signatureImageDigital:{type:String},signature:{type:String},signatureImageHashSignature:{type:String},qrCode:{type:String}},{_id:!1}),o=new a.Schema({fileHash:{type:String,required:!0},encryptedAesKeyForUploader:{type:String,required:!0},encryptedAesKeyForRecipient:{type:String,required:!0}},{_id:!1}),d=new a.Schema({title:{type:String,required:!0},uploaderId:{type:String,required:!0},recipientId:{type:String,required:!0},senderEmail:{type:String},recipientEmail:{type:String},filePath:{type:String,required:!0},status:{type:String,required:!0,default:n.r.Uploaded,enum:Object.values(n.r)},expirationDate:{type:Date,required:!0},received:{type:Boolean,default:!1},deletedBy:{type:[String],default:[]},security:{type:o,required:!0},signature:{type:i,default:void 0}},{timestamps:!0}),u=r().models.Contract||r().model("Contract",d)},96904:(e,t,s)=>{s.d(t,{Z:()=>i});var a=s(11185),r=s.n(a);let n=new a.Schema({contractId:{type:String,required:!0},filePath:{type:String,required:!0},encapsulation:{type:String,required:!0},tag:{type:String,required:!0},hash:{type:String,required:!0},previousHash:{type:String},filename:{type:String,required:!0}},{timestamps:!0}),i=r().models.Log||r().model("Log",n)}};var t=require("../../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),a=t.X(0,[9276,5972,1482,7060],()=>s(10569));module.exports=a})();