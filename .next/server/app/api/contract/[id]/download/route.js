"use strict";(()=>{var e={};e.id=1511,e.ids=[1511],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},92048:e=>{e.exports=require("fs")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},54017:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>E,patchFetch:()=>x,requestAsyncStorage:()=>h,routeModule:()=>S,serverHooks:()=>N,staticGenerationAsyncStorage:()=>A});var o={};r.r(o),r.d(o,{GET:()=>O,OPTIONS:()=>f});var n=r(49303),s=r(88716),i=r(60670),a=r(87070),c=r(45256),l=r(20975),p=r(92048),d=r(55315),u=r.n(d),g=r(41482),y=r.n(g),D=r(96904);async function m(e){let t=e.cookies.get("token")?.value;if(!t||!process.env.JWT_SECRET)return null;try{return y().verify(t,process.env.JWT_SECRET)}catch{return null}}async function O(e,t){try{let o,n,s,i,d,g;await (0,c.X)();let y=await m(e);if(!y||"object"!=typeof y)return a.NextResponse.json({message:"인증이 필요합니다."},{status:401});let O=t.params.id,f=await l.Z.findById(O);if(!f)return a.NextResponse.json({message:"Contract not found"},{status:404});let S="";if(!("id"in y)||!y.id)return a.NextResponse.json({message:"권한이 없습니다."},{status:403});if(S=y.id,"expired"===f.status)return a.NextResponse.json({message:"계약서가 만료되었습니다."},{status:403});if("rejected"===f.status&&S===f.recipientId?.toString())return a.NextResponse.json({message:"계약서가 거부/반려되었습니다."},{status:403});if(S===f.recipientId?.toString()&&"signed"!==f.status)return a.NextResponse.json({message:"모든 인증 및 서명 완료 후 다운로드 가능합니다."},{status:403});if(S!==f.recipientId?.toString()&&S!==f.uploaderId?.toString())return a.NextResponse.json({message:"권한이 없습니다."},{status:403});let h=f.filePath.replace(/^[/\\]+/,""),A=u().resolve("uploads",h);try{o=(0,p.readFileSync)(A)}catch(e){return a.NextResponse.json({message:"파일을 읽을 수 없습니다."},{status:500})}let N=await D.Z.findOne({contractId:f._id}).sort({_id:-1}),E=N?N.hash:"",x=f.security?.fileHash||"";await D.Z.create({contractId:f._id,filePath:f.filePath,encapsulation:"download",tag:"contract",hash:x,previousHash:E,filename:f.title});let v=u().extname(f.title).toLowerCase();console.log("[DOWNLOAD DEBUG] contract.status:",f.status),console.log("[DOWNLOAD DEBUG] userId:",S),console.log("[DOWNLOAD DEBUG] uploaderId:",f.uploaderId),console.log("[DOWNLOAD DEBUG] recipientId:",f.recipientId),console.log("[DOWNLOAD DEBUG] 다운로드 요청 userId:",S),console.log("[DOWNLOAD DEBUG] contract.uploaderId:",f.uploaderId),console.log("[DOWNLOAD DEBUG] contract.recipientId:",f.recipientId);let B=S===f.uploaderId?.toString(),U=S===f.recipientId?.toString();console.log("[DOWNLOAD DEBUG] isUploader:",B),console.log("[DOWNLOAD DEBUG] isRecipient:",U);try{i=JSON.parse(B?f.security.encryptedAesKeyForUploader:f.security.encryptedAesKeyForRecipient),console.log("[DOWNLOAD DEBUG] encAesKeyObj:",i)}catch(e){return console.error("[DOWNLOAD DEBUG] encAesKeyObj JSON parse error:",e),a.NextResponse.json({message:"encryptedAesKeyObj 파싱 오류",error:String(e)},{status:500})}let G=e.headers.get("x-private-key");if(!G)return console.error("[DOWNLOAD DEBUG] x-private-key header 없음"),a.NextResponse.json({message:"개인키가 필요합니다."},{status:400});try{d=Buffer.from(G,"base64").toString("utf-8"),console.log("[DOWNLOAD DEBUG] privateKeyPem(first 50):",d.slice(0,50)+"..."),console.log("[DOWNLOAD DEBUG] 전달받은 privateKeyPem 전체:",d)}catch(e){return console.error("[DOWNLOAD DEBUG] privateKeyPem 디코딩 오류:",e),a.NextResponse.json({message:"개인키 디코딩 오류",error:String(e)},{status:400})}let I=r(71732).Z,L="";try{if(B){let e=await I.findById(f.uploaderId);L=e?.publicKey||""}else{let e=await I.findById(f.recipientId);L=e?.publicKey||""}console.log("[DOWNLOAD DEBUG] 사용된 공개키(앞 50):",L.slice(0,50)+"..."),console.log("[DOWNLOAD DEBUG] 사용된 공개키 전체:",L)}catch(e){console.error("[DOWNLOAD DEBUG] 공개키 조회 오류:",e)}console.log("[DOWNLOAD DEBUG] 사용된 개인키(앞 50):",d.slice(0,50)),console.log("[DOWNLOAD DEBUG] encAesKeyObj:",i),console.log("[DOWNLOAD DEBUG] encAesKeyObj 전체:",JSON.stringify(i,null,2));try{console.log("[DOWNLOAD DEBUG] 복호화 시도: forge.pki.privateKeyFromPem");let e=r(37060),t=e.pki.privateKeyFromPem(d);console.log("[DOWNLOAD DEBUG] 복호화 시도: privateKey 객체 생성 성공"),t.publicKey?console.log("[DOWNLOAD DEBUG] privateKey.publicKey 있음"):console.log("[DOWNLOAD DEBUG] privateKey.publicKey 없음, n/e:",t.n&&t.n.toString().slice(0,20),t.e&&t.e.toString()),console.log("[DOWNLOAD DEBUG] 복호화 시도: privateKey.decrypt"),g=t.decrypt(e.util.decode64(i.ciphertext),"RSAES-PKCS1-V1_5"),console.log("[DOWNLOAD DEBUG] 복호화 성공!"),n=Buffer.from(g,"binary"),s=Buffer.from(i.iv,"hex"),console.log("[DOWNLOAD DEBUG] decryptedAesKey(first 16):",n.toString("hex").slice(0,32)+"...")}catch(e){return console.error("[DOWNLOAD DEBUG] 복호화 실패:",e),console.error("[DOWNLOAD DEBUG] 복호화 실패 상세:",{privateKeyPemFirst50:d.slice(0,50),usedPublicKeyFirst50:L.slice(0,50),encAesKeyObj:i,isUploader:B,isRecipient:U,error:String(e),stack:e instanceof Error?e.stack:void 0}),a.NextResponse.json({message:"AES키 복호화 오류",error:String(e),encAesKeyObj:i,privateKeyPemFirst50:d.slice(0,50),isUploader:B,isRecipient:U},{status:500})}try{let e=r(84770).createDecipheriv("aes-256-cbc",n,s),t=Buffer.concat([e.update(o),e.final()]),i="application/octet-stream";return".pdf"===v?i="application/pdf":".docx"===v&&(i="application/vnd.openxmlformats-officedocument.wordprocessingml.document"),new a.NextResponse(t,{status:200,headers:{"Content-Type":i,"Content-Disposition":`attachment; filename="${encodeURIComponent(f.title)}"`,"Cache-Control":"no-store"}})}catch(e){return console.error("[DOWNLOAD DEBUG] 파일 복호화 오류:",e),a.NextResponse.json({message:"파일 복호화 오류",error:String(e)},{status:500})}if(U)try{let e=r(37060),t=e.pki.privateKeyFromPem(d),o=e.pki.rsa.setPublicKey(t.n,t.e),n=e.pki.publicKeyToPem(o),s=r(84770).createHash("sha256").update(n).digest("hex"),i=f.security?.recipientPublicKeyHash;if(s!==i)return a.NextResponse.json({message:"수신자 키 쌍이 일치하지 않습니다. 업로드 시점의 공개키와 현재 개인키가 다릅니다.",publicKeyHash:s,expectedHash:i},{status:400})}catch(e){return a.NextResponse.json({message:"수신자 공개키 해시 검증 오류",error:String(e)},{status:400})}}catch(e){return console.error("[DOWNLOAD API ERROR]",e),a.NextResponse.json({message:"서버 오류",error:e instanceof Error?e.message:String(e),stack:e instanceof Error?e.stack:void 0},{status:500})}}async function f(){return a.NextResponse.json({},{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"GET, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"}})}let S=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/contract/[id]/download/route",pathname:"/api/contract/[id]/download",filename:"route",bundlePath:"app/api/contract/[id]/download/route"},resolvedPagePath:"E:\\test2\\app\\api\\contract\\[id]\\download\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:h,staticGenerationAsyncStorage:A,serverHooks:N}=S,E="/api/contract/[id]/download/route";function x(){return(0,i.patchFetch)({serverHooks:N,staticGenerationAsyncStorage:A})}},23634:(e,t,r)=>{var o;r.d(t,{r:()=>o}),function(e){e.Uploaded="uploaded",e.Signed="signed",e.Expired="expired",e.Rejected="rejected"}(o||(o={}))},45256:(e,t,r)=>{let o;r.d(t,{X:()=>a});var n=r(11185),s=r.n(n);let i=process.env.MONGODB_URI;if(!i)throw Error("MongoDB URI가 .env에 설정되어 있지 않습니다.");async function a(){o.conn&&o.conn.readyState>=1||(o.promise||(o.promise=s().connect(i).then(e=>e.connection)),o.conn=await o.promise)}global.mongoose?o=global.mongoose:(o={conn:null,promise:null},global.mongoose=o)},20975:(e,t,r)=>{r.d(t,{Z:()=>l});var o=r(11185),n=r.n(o),s=r(23634);let i=new o.Schema({signed:{type:Boolean,default:!1},signer:{type:String},certificate:{type:String},signatureImageHash:{type:String},signatureImageDigital:{type:String},signature:{type:String},signatureImageHashSignature:{type:String},qrCode:{type:String}},{_id:!1}),a=new o.Schema({fileHash:{type:String,required:!0},encryptedAesKeyForUploader:{type:String,required:!0},encryptedAesKeyForRecipient:{type:String,required:!0}},{_id:!1}),c=new o.Schema({title:{type:String,required:!0},uploaderId:{type:String,required:!0},recipientId:{type:String,required:!0},senderEmail:{type:String},recipientEmail:{type:String},filePath:{type:String,required:!0},status:{type:String,required:!0,default:s.r.Uploaded,enum:Object.values(s.r)},expirationDate:{type:Date,required:!0},received:{type:Boolean,default:!1},deletedBy:{type:[String],default:[]},security:{type:a,required:!0},signature:{type:i,default:void 0}},{timestamps:!0}),l=n().models.Contract||n().model("Contract",c)},96904:(e,t,r)=>{r.d(t,{Z:()=>i});var o=r(11185),n=r.n(o);let s=new o.Schema({contractId:{type:String,required:!0},filePath:{type:String,required:!0},encapsulation:{type:String,required:!0},tag:{type:String,required:!0},hash:{type:String,required:!0},previousHash:{type:String},filename:{type:String,required:!0}},{timestamps:!0}),i=n().models.Log||n().model("Log",s)},71732:(e,t,r)=>{r.d(t,{Z:()=>i});var o=r(11185),n=r.n(o);let s=new o.Schema({username:{type:String,required:!0,unique:!0},email:{type:String,required:!0,unique:!0},password:{type:String,required:!0},publicKey:{type:String},certificate:{type:String},otpEnabled:{type:Boolean,default:!1},otpSecret:{type:String},otpVerified:{type:Boolean,default:!1},certificateStatus:{type:String,default:"valid"},currentRefreshJti:{type:String}}),i=n().models.User||n().model("User",s)}};var t=require("../../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[9276,5972,1482,7060],()=>r(54017));module.exports=o})();