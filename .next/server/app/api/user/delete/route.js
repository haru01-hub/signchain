"use strict";(()=>{var e={};e.id=8793,e.ids=[8793],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},76162:e=>{e.exports=require("stream")},21764:e=>{e.exports=require("util")},99487:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>q,patchFetch:()=>v,requestAsyncStorage:()=>f,routeModule:()=>S,serverHooks:()=>x,staticGenerationAsyncStorage:()=>h});var n={};r.r(n),r.d(n,{DELETE:()=>y,OPTIONS:()=>m});var a=r(49303),i=r(88716),s=r(60670),o=r(87070),d=r(45256),p=r(71732),u=r(36454),l=r(41482),c=r.n(l),g=r(20975);async function y(e){let t;await (0,d.X)();let r=e.cookies.get("token")?.value;if(!r)return o.NextResponse.json({message:"Unauthorized"},{status:401});try{if(!process.env.JWT_SECRET)return o.NextResponse.json({message:"서버 설정 오류: JWT_SECRET이 정의되지 않았습니다."},{status:500});t=c().verify(r,process.env.JWT_SECRET)}catch(e){return o.NextResponse.json({message:"유효하지 않은 토큰입니다."},{status:403})}let n=t?.id,a=await p.Z.startSession();a.startTransaction();try{let e=await p.Z.findById(n);if(!e)return await a.abortTransaction(),a.endSession(),o.NextResponse.json({message:"User not found"},{status:404});await g.Z.updateMany({recipientId:n,status:{$ne:"signed"}},{$set:{status:"rejected"}}),await u.Z.deleteMany({recipientEmail:e.email}),e.certificateStatus="revoked",await e.save(),await p.Z.findByIdAndDelete(n),await a.commitTransaction(),a.endSession();let t=o.NextResponse.json({message:"Account deleted, certificate revoked. Contracts remain."});return t.headers.set("Set-Cookie","token=; Path=/; HttpOnly; Max-Age=0; SameSite=Lax;"),t.headers.append("Set-Cookie","refresh_token=; Path=/; HttpOnly; Max-Age=0; SameSite=Lax;"),t}catch(e){return await a.abortTransaction(),a.endSession(),console.error("Account deletion error:",e),o.NextResponse.json({message:"Failed to delete account and related data"},{status:500})}}async function m(){return o.NextResponse.json({},{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"DELETE, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"}})}let S=new a.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/user/delete/route",pathname:"/api/user/delete",filename:"route",bundlePath:"app/api/user/delete/route"},resolvedPagePath:"E:\\test2\\app\\api\\user\\delete\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:f,staticGenerationAsyncStorage:h,serverHooks:x}=S,q="/api/user/delete/route";function v(){return(0,s.patchFetch)({serverHooks:x,staticGenerationAsyncStorage:h})}},23634:(e,t,r)=>{var n;r.d(t,{r:()=>n}),function(e){e.Uploaded="uploaded",e.Signed="signed",e.Expired="expired",e.Rejected="rejected"}(n||(n={}))},45256:(e,t,r)=>{let n;r.d(t,{X:()=>o});var a=r(11185),i=r.n(a);let s=process.env.MONGODB_URI;if(!s)throw Error("MongoDB URI가 .env에 설정되어 있지 않습니다.");async function o(){n.conn&&n.conn.readyState>=1||(n.promise||(n.promise=i().connect(s).then(e=>e.connection)),n.conn=await n.promise)}global.mongoose?n=global.mongoose:(n={conn:null,promise:null},global.mongoose=n)},20975:(e,t,r)=>{r.d(t,{Z:()=>p});var n=r(11185),a=r.n(n),i=r(23634);let s=new n.Schema({signed:{type:Boolean,default:!1},signer:{type:String},certificate:{type:String},signatureImageHash:{type:String},signatureImageDigital:{type:String},signature:{type:String},signatureImageHashSignature:{type:String},qrCode:{type:String}},{_id:!1}),o=new n.Schema({fileHash:{type:String,required:!0},encryptedAesKeyForUploader:{type:String,required:!0},encryptedAesKeyForRecipient:{type:String,required:!0}},{_id:!1}),d=new n.Schema({title:{type:String,required:!0},uploaderId:{type:String,required:!0},recipientId:{type:String,required:!0},senderEmail:{type:String},recipientEmail:{type:String},filePath:{type:String,required:!0},status:{type:String,required:!0,default:i.r.Uploaded,enum:Object.values(i.r)},expirationDate:{type:Date,required:!0},received:{type:Boolean,default:!1},deletedBy:{type:[String],default:[]},security:{type:o,required:!0},signature:{type:s,default:void 0}},{timestamps:!0}),p=a().models.Contract||a().model("Contract",d)},36454:(e,t,r)=>{r.d(t,{Z:()=>s});var n=r(11185),a=r.n(n);let i=new n.Schema({recipientEmail:{type:String,required:!0},message:{type:String,required:!0},timestamp:{type:Date,default:Date.now},read:{type:Boolean,default:!1},type:{type:String,enum:["system","message"],default:"system"},contractId:{type:n.Schema.Types.ObjectId,ref:"Contract"},senderEmail:{type:String}}),s=a().models.Notification||a().model("Notification",i)},71732:(e,t,r)=>{r.d(t,{Z:()=>s});var n=r(11185),a=r.n(n);let i=new n.Schema({username:{type:String,required:!0,unique:!0},email:{type:String,required:!0,unique:!0},password:{type:String,required:!0},publicKey:{type:String},certificate:{type:String},otpEnabled:{type:Boolean,default:!1},otpSecret:{type:String},otpVerified:{type:Boolean,default:!1},certificateStatus:{type:String,default:"valid"},currentRefreshJti:{type:String}}),s=a().models.User||a().model("User",i)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[9276,5972,1482],()=>r(99487));module.exports=n})();