"use strict";(()=>{var e={};e.id=5841,e.ids=[5841],e.modules={11185:e=>{e.exports=require("mongoose")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},86689:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>q,patchFetch:()=>v,requestAsyncStorage:()=>S,routeModule:()=>m,serverHooks:()=>h,staticGenerationAsyncStorage:()=>f});var n={};r.r(n),r.d(n,{OPTIONS:()=>y,POST:()=>g});var i=r(49303),o=r(88716),a=r(60670),s=r(87070),d=r(45256),p=r(20975),u=r(96904),c=r(11185),l=r.n(c);async function g(e){await (0,d.X)();try{let t;let{contractId:r,qrCode:n}=await e.json();if(console.log("[QR VERIFY] contractId:",r,typeof r),console.log("[QR VERIFY] qrCode:",n,typeof n),!r||!n)return s.NextResponse.json({message:"contractId와 qrCode가 필요합니다.",success:!1},{status:400});try{t=new(l()).Types.ObjectId(r)}catch(e){return s.NextResponse.json({message:"contractId 형식이 올바르지 않습니다.",success:!1},{status:400})}let i=await p.Z.findOne({_id:t,"signature.qrCode":n.trim()});if(console.log("[QR VERIFY] contract:",i),i&&i.signature&&console.log("[QR VERIFY] contract.signature.qrCode:",i.signature.qrCode),!i)return s.NextResponse.json({message:"QR 코드 인증 실패: 올바른 QR이 아닙니다.",success:!1},{status:400});let o={contractId:i._id,filePath:i.filePath||"",encapsulation:"qr",tag:"qr_verified",hash:"",filename:i.title||"",qrCode:n,verified:!0,timestamp:new Date,previousHash:""},a="";if(i){let e=await u.Z.findOne({contractId:i._id}).sort({_id:-1});a=e?e.hash:""}o.previousHash=a;try{await u.Z.create(o)}catch(e){}return s.NextResponse.json({message:"QR 코드 인증 성공",success:!0})}catch(e){return console.error("QR 코드 검증 오류:",e),s.NextResponse.json({message:"Server error"},{status:500})}}async function y(){return s.NextResponse.json({},{status:200,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"}})}let m=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/Qr/verify-qr/route",pathname:"/api/Qr/verify-qr",filename:"route",bundlePath:"app/api/Qr/verify-qr/route"},resolvedPagePath:"E:\\test2\\app\\api\\Qr\\verify-qr\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:S,staticGenerationAsyncStorage:f,serverHooks:h}=m,q="/api/Qr/verify-qr/route";function v(){return(0,a.patchFetch)({serverHooks:h,staticGenerationAsyncStorage:f})}},23634:(e,t,r)=>{var n;r.d(t,{r:()=>n}),function(e){e.Uploaded="uploaded",e.Signed="signed",e.Expired="expired",e.Rejected="rejected"}(n||(n={}))},45256:(e,t,r)=>{let n;r.d(t,{X:()=>s});var i=r(11185),o=r.n(i);let a=process.env.MONGODB_URI;if(!a)throw Error("MongoDB URI가 .env에 설정되어 있지 않습니다.");async function s(){n.conn&&n.conn.readyState>=1||(n.promise||(n.promise=o().connect(a).then(e=>e.connection)),n.conn=await n.promise)}global.mongoose?n=global.mongoose:(n={conn:null,promise:null},global.mongoose=n)},20975:(e,t,r)=>{r.d(t,{Z:()=>p});var n=r(11185),i=r.n(n),o=r(23634);let a=new n.Schema({signed:{type:Boolean,default:!1},signer:{type:String},certificate:{type:String},signatureImageHash:{type:String},signatureImageDigital:{type:String},signature:{type:String},signatureImageHashSignature:{type:String},qrCode:{type:String}},{_id:!1}),s=new n.Schema({fileHash:{type:String,required:!0},encryptedAesKeyForUploader:{type:String,required:!0},encryptedAesKeyForRecipient:{type:String,required:!0}},{_id:!1}),d=new n.Schema({title:{type:String,required:!0},uploaderId:{type:String,required:!0},recipientId:{type:String,required:!0},senderEmail:{type:String},recipientEmail:{type:String},filePath:{type:String,required:!0},status:{type:String,required:!0,default:o.r.Uploaded,enum:Object.values(o.r)},expirationDate:{type:Date,required:!0},received:{type:Boolean,default:!1},deletedBy:{type:[String],default:[]},security:{type:s,required:!0},signature:{type:a,default:void 0}},{timestamps:!0}),p=i().models.Contract||i().model("Contract",d)},96904:(e,t,r)=>{r.d(t,{Z:()=>a});var n=r(11185),i=r.n(n);let o=new n.Schema({contractId:{type:String,required:!0},filePath:{type:String,required:!0},encapsulation:{type:String,required:!0},tag:{type:String,required:!0},hash:{type:String,required:!0},previousHash:{type:String},filename:{type:String,required:!0}},{timestamps:!0}),a=i().models.Log||i().model("Log",o)}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[9276,5972],()=>r(86689));module.exports=n})();